<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
          "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>DART Manhattan Differences from Lanai Release Notes</title>
<link rel="stylesheet" type="text/css" href="doc.css" />
<link href="../images/dart.ico" rel="shortcut icon" />
</head>
<body>
<a name="TOP"></a>

<h1>DART Manhattan Differences from Lanai Release Notes</h1>

<table border=0 summary="" cellpadding=5>
<tr>
    <td valign=middle>
    <img src="../images/Dartboard7.png" alt="DART project logo" height=70 />
    </td>
    <td>
       <p>Jump to DART Documentation Main Index 
       <a href="https://svn-dares-dart.cgd.ucar.edu/DART/branches/rma_trunk/documentation/index.html">Website</a>  
       or <a href="../../../documentation/index.html">local file</a><br />
          <small><small>version information for this file: <br />
          <!-- version tag follows, do not edit -->
          $Id: Manhattan_diffs_from_Lanai.html 11243 2017-03-08 21:35:09Z nancy@ucar.edu $</small></small>
       </p></td>
</tr>
</table>

<a href="#Overview">Overview</a> /
<!-- <a href="#NewModels">New Models or Changes to Existing Models</a> / -->
<a href="#NetcdfRestarts">NetCDF Restart Files</a> /
<a href="#ForwardOps">Calculation of Forward Operators</a> /
<a href="#ObsConvert">Vertical Conversion of Observations</a> /
<a href="#Diagnostics">DART Diagnostics Changes</a> /
<a href="#NameListChanges">Additions/Changes to Existing Namelists</a> /
<a href="#Perturbations">Perturbations</a> /
<!-- <a href="#Misc">Tutorial, Scripting, Setup, Builds</a> / -->
<a href="#Legalese">Terms of Use</a>

<!--==================================================================-->

<A NAME="Overview"></A>
<H2>Overview</H2>
<P>
This document includes an overview of the changes in the DART
system since the Lanai release.  For further details on any of
these items look at the HTML documentation for that specific part
of the system.
</P>
In the Manhattan version of DART, the state vector is not required to be stored 
completely on any process. This is achieved using Remote Memory Access (RMA).  
The RMA programing model allows processes to read (and write) memory on other 
processors asynchronously.

Manhattan supported models:
<ul>
<li> 9var 
<li> bgrid_solo 
<li> cam-fv 
<li> cice 
<li> cm1 
<li> forced_lorenz_96 
<li> lorenz_63 
<li> lorenz_84 
<li> lorenz_96 
<li> lorenz_04 
<li> mpas_atm (NetCDF overwrite not supported for update_u_from_reconstruct = .true. )
<li> POP 
<li> ROMS 
<li> simple_advection
<li> wrf
</ul>

There are six major differences between Lanai and RMA DART:
<ul>
<li> Read and write NetCDF restarts
<li> Calculation of forward operators
<li> Vertical conversion of observation locations
<li> Diagnostic file changes
<li> <a href="state_structure.html">State structure module </a>
<li> Perturbation of the state
</ul>

<p> Before bitwise testing with Lanai please read 
<a href="bitwise_considerations.html">bitwise considerations</a>

<!--==================================================================-->

<A NAME="NetcdfRestarts"></A>
<h2> NetCDF Restart Files </h2>

The programs filter and perfect_model_obs now read/write directly from NetCDF 
files, rather than having to run converters (<code>model_to_dart</code> and 
<code>dart_to_model</code>).

To facilitate this, there is a new required call <code>add_domain</code> 
which must be called during <code>static_init_model</code>.  It can be called 
multiple times in static_model_mod, e.g. once for each NetCDF file that 
contains state variables.  There are three ways to add a domain:

<ul>
<li> <b>From Blank</b> : This is for small models such as lorenz_96 and no NetCDF restarts
   <ul>
   <li> <code>dom_id = add_domain(model_size)</code>
   </ul>
<li> <b>From File</b> : This is for models which have NetCDF restart files
   <ul>
   <li> <code>dom_id = add_domain(template_file, num_vars, var_names, ... )</code>
   </ul>
<li> <b>From Spec</b> : Creates a skeleton structure for a domain ( currently only used in 
                 bgrid_solo )
   <ul>
   <li> <code>dom_id = add_domain(num_vars, var_names, ... )</code><br>
        <code>call add_dimension_to_variable(dom_id, var_id, dim_nam, dim_size)</code> <br>
        <code>call finished_adding_domain</code>
   </ul>
</ul>
</ul>
<p>
For models without NetCDF restarts, use <code>add_domain(model_size)</code>. 
This is the minimum amount of information needed by DART to create a netdcf 
file.  For models with NetCDF restarts use 
<code>add_domain(info_file, num_vars, var_names)</code> which lets DART read 
the NetCDF dimensions for a list of variables from a file 
(<code>info_file</code>). There are several routines that can be used together 
to create a domain from a decsription:
<code>add_domain, add_dimension_to_variable, finished_adding_domain</code>. 
This can be used in models such as bgrid_solo where the model is spun up in 
perfect_model_obs, but the model itself has variable structure 
(3D variables with names).

See <a href="#namelist_changes">Additions/Changes to existing namelists for how to use NetCDF IO</a>.

<p>
<b>Note</b> when using NetCDF restarts, inflation files are NetCDF also. 
The inflation mean and inflation standard deviation are in separate files 
when you use NetCDF restarts. See <a href="documentation/html/netcdf_inflation_files.html">NetCDF inflation files</a> for details.

<!--==================================================================-->

<A NAME="ForwardOps"></A>
<h2> Calculation of Forward Operators</h2>
The forward operator code in model_mod now operates on an array of state 
values. See <a href="documentation/html/forward_operator.html">forward operator</a> for more 
detail about distributed vs. non-distributed forward operators.

In distributed mode the forward operators for all ensemble members are
calculated in the same <code>model_interpolate</code> call.  In non-distributed
mode, the forward oeprators for all ensemble members a task owns (1-ens_size) 
are calculated at once.

<!--==================================================================-->

<A NAME="ObsConvert"></A>
<h2> Vertical Conversion of Observations </h2>
The vertical conversion of observation locations is done before the 
assimilation. In Lanai this calculation is done in the assimilation as part
of <code>get_close_obs</code> if a model_mod does vertical conversion. See 
<a href="documentation/html/vertical_conversion.html">vertical conversion</a> for details about 
this change.  Note that not all models do vertical conversion or even have a 
concept of vertical location, but every model_mod must have the following 
routines:

<ul>
<li>
<code>query_vert_localization_coord</code> - returns the vertical localization 
coordiate (or does nothing if there is no vertical conversion)
<li>
<code>vert_convert</code> - converts location to required vertical (or does 
nothing if there is no vertical conversion)
</ul>
<p>

<!--==================================================================-->

<A NAME="Diagnostics"></A>
<h2> DART Diagnostic file changes</h2>
For large models DART format diagnostic files (Prior_Diag.nc and 
Posterior_Diag.nc) have been replaced with separate files for each copy that would 
have gone into Prior_Diag.nc and Posterior_Diag.nc.
<p>

For Prior_Diag.nc:

<ul>
<li><b>Mean and standard deviation</b>:
   <br>&nbsp;&nbsp;preassim_mean.nc
   <br>&nbsp;&nbsp;preassim_sd.nc
<li><b>Inflation mean and standard deviation</b> (if state space inflation is used):
   <br>&nbsp;&nbsp;preassim_priorinf_mean.nc
   <br>&nbsp;&nbsp;preassim_priorinf_sd.nc
<li><b>The number of ensemble members specifed</b> in filter_nml (num_output_state_members):
   <br>&nbsp;&nbsp;preassim_member.000*.nc
</ul>

<p>

For Posterior_Diag.nc:

<ul>
<li><b>Mean and standard deviation</b>:
   <br>&nbsp;&nbsp;postassim_mean.nc
   <br>&nbsp;&nbsp;postassim_sd.nc
<li><b>Inflation mean and standard deviation</b> (if state space inflation is used):
   <br>&nbsp;&nbsp;postassim_priorinf_mean.nc
   <br>&nbsp;&nbsp;postassim_priorinf_sd.nc
<li><b>The number of ensemble members specifed</b> in filter_nml (num_output_state_members):
   <br>&nbsp;&nbsp;postassim_member.000*.nc
</ul>
<p>

The <code>num_output_state_members</code> are not written separately from the restarts. 
Note that restarts will have been clamped if any clamping is applied (given 
as an arguement to add_domain). This is <em>different</em> to Posterior_Diag.nc
which contains unclamped values.

<p> For models with multiple domains the filenames above are appended with the 
domain number, e.g. preassim_mean.nc becomes preassim_mean_d01.nc, 
preassim_mean_d02.nc, etc.

<h5>Changes to nc_write_model_atts</h5>
<code>nc_write_model_atts</code> has an new argument 
'<code>model_mod_writes_state_variables</code>'. 
This is used to communicate to DART whether the model will create and write
state variables in Prior_Diag.nc and Posterior_Diag.nc.  If 
<code>model_model_writes_state_variables = .false.</code> 
DART will define and write state variables to the new diagnostic files.  If 
<code>model_model_writes_state_variables = .true.,  nc_write_model_vars</code> 
is called as normal.

<!--==================================================================-->

<A NAME="NamelistChanges"></A>
<H2> Additions/Changes to Existing Namelists </H2>

<P>
<h4>quality_control_nml</h4>

These namelist options used to be in filter_nml, now they are in quality_control_nml.
<P>
<div class=namelist>
<pre>
&amp;quality_control_nml
   input_qc_threshold          = 3,
   outlier_threshold           = 4,
   enable_special_outlier_code = .false.
/
</pre>
</div>

New namelist variables

<h4>filter_nml</h4>

<P>
<div class=namelist>
<pre>
&amp;filter_nml
   single_file_in               = .false.,
   single_file_out              = .false.,

   input_state_file_list        = 'null',
   output_state_file_list       = 'null',
   input_state_files            = 'null',
   output_state_files           = 'null',

   stages_to_write              = 'output'
   write_all_stages_at_end      = .false.
   output_restarts              = .true.
   output_mean                  = .true.
   output_sd                    = .true.

   perturb_from_single_instance = .false.,
   perturbation_amplitude       = 0.2_r8,

   distributed_state            = .true.
/
</pre>
</div>

<br />


<div>
<TABLE border=0 cellpadding=10 width=100% summary='namelist description'>
<THEAD align=left>
<TR><TH> Item </TH>
    <TH> Type </TH>
    <TH> Description </TH> </TR>
</THEAD>

<TBODY valign=top>
<TR><TD>single_file_in</TD>
    <TD>logical</TD>
    <TD>True mean that all of the restart and inflation information is read from
        a single NetCDF file.  False means that you must specify a input_state_file_list
        and DART will be expecting input_{priorinf,postinf}_{mean,sd}.nc files for 
        inflation.
 </TD></TR>

<TR><TD>single_file_out</TD>
    <TD>logical</TD>
    <TD>True mean that all of the restart and inflation information is written to
        a single NetCDF file.  False means that you must specify a 
        output_state_files and DART will be output files specified in the
        list.  Inflation files will be written in the form 
        input_{priorinf,postinf}_{mean,sd}.nc.
 </TD></TR>

<TR><TD>input_state_files</TD>
    <TD>character array</TD>
    <TD>This is used for single file input for low order models. For multiple domains 
        you can specify a file for each domain. When specifying a list single_file_in, 
        single_file_out must be set to .true.
 </TD></TR>

<TR><TD>output_state_files</TD>
    <TD>character array</TD>
    <TD>This is used for single file input for low order models. For multiple domains 
        you can specify a file for each domain. When specifying a list single_file_in, 
        single_file_out must be set to .true.
 </TD></TR>

<TR><TD>input_state_file_list</TD>
    <TD>character array</TD>
    <TD>A list of files containing input model restarts. For multiple domains you can 
        specify a file for each domain. When specifying a list single_file_in, 
        single_file_out must be set to .false.
 </TD></TR>

<TR><TD>output_state_files</TD>
    <TD>character array</TD>
    <TD>A list of files containing output model restarts. For multiple domains you can 
        specify a file for each domain. When specifying a list single_file_in, 
        single_file_out must be set to .false.
 </TD></TR>

<TBODY valign=top>
<TR><TD>stages_to_write</TD>
    <TD>character array</TD>
    <TD>Controls which stages to write. Currently there are four options:
         <UL>
          <LI><code>input</code> -- outputs input mean and sd only</LI>
          <LI><code>preassim</code> -- before assimilation, before prior inflation 
              is applied</LI>
          <LI><code>postassim</code> -- after assimilation, before posterior inflation 
               is applied</LI>
          <LI><code>output</code> -- final output for filter which includes clamping 
              and inflation</LI>
         </UL>
 </TD></TR>

<TR><TD>write_all_stages_at_end</TD>
    <TD>logical</TD>
    <TD>True means output all stages at the end of filter.  This is more memory 
        intensive but requires less memory.  For larger models IO begins to dominate
        the overall cost of the assimilation so writting all stages at the end write
        more files in parallel, reducing the IO time.
        <code>output_state_files</code>.
 </TD></TR>


<TR><TD>output_restarts</TD>
    <TD>logical</TD>
    <TD>True means output a restart file(s). Filenames are defined in 
        <code>output_state_files</code>.
 </TD></TR>

<TR><TD>output_mean</TD>
    <TD>logical</TD>
    <TD>True means output a restart file which contains the ensemble mean for
        the stages that have been turned on in <code>stages_to_write</code>.  
        The file name will have the stage with <em class=code>_mean</em> appended.
 </TD></TR>

<TR><TD>output_sd</TD>
    <TD>logical</TD>
    <TD>True means output a restart file which contains the ensemble sd for
        the stages that have been turned on in <code>stages_to_write</code>.  
        The file name will have the stage with <em class=code>_sd</em> appended.
 </TD></TR>

<TR><TD>perturb_from_single_instance</TD>
    <TD>logical</TD>
    <TD>Read a single file and perturb this to create an ensemble
 </TD></TR>

<TR><TD>perturbation_amplitude</TD>
    <TD>float</TD>
    <TD>Perturbation amplitude
 </TD></TR>

<TR><TD>distribute_state</TD>
    <TD>logical</TD>
    <TD>True keeps the state distributed across all tasks throughout the entire
        execution of filter.
 </TD></TR>

</TBODY> 
</TABLE>
</div>

<p>
<b>NetCDF reads and writes:</b>
<p>
For <b>input</b> file names:
<ul>
<li> <code>input_state_file_list to</code> give a file (one for each domain) 
     containing a list of restart files. An example of a 'input_list.txt' might
     look something like :

<br>
<div class=namelist>
<pre>
advance_temp1/wrfinput_d01
advance_temp2/wrfinput_d01
advance_temp3/wrfinput_d01
advance_temp4/wrfinput_d01
advance_temp5/wrfinput_d01
....
</pre>
</div>
<br/>

<li> if no <code>input_state_file_list</code> is provided then default 
     filenames will be used e.g. input_member_000*.nc, input_priorinf_mean.nc, 
     input_priorinf_sd.nc
</ul>

<p>
For <b>output</b> file names:
<ul>
<li> <code>output_state_file_list</code> to give a file (one for each domain)
     containing a list of restart files. An Example of an 'output_list.txt'
     for WRF might look something like :

<br>
<div class=namelist>
<pre>
wrf_out_d01.0001.nc
wrf_out_d01.0002.nc
wrf_out_d01.0003.nc
wrf_out_d01.0004.nc
wrf_out_d01.0005.nc
....
</pre>
</div>
<br/>
     if you would like to simply like to overwrite your previous data
     input_list.txt = output_list.txt

<li> if no <code>output_state_files</code> is provided then default 
     filenames will be used e.g. output_member_000*.nc, 
     output_priorinf_mean.nc, output_priorinf_sd.nc
</ul>
For small models you may want to use <code>single_file_in</code>, 
<code>single_file_out</code> which contains all copies needed to run filter.

<!--
<p>
<b>For Lanai style dart input and output restart files:</b> <br>
<ul>
<li> output_state_files and restart_out_file_name are used in the same way as Lanai.
</ul>
-->
<h4>state_vector_io_nml</h4>

<P>
<div class=namelist>
<pre>
&amp;state_vector_io_nml
   limit_mem                  = HUGE(1_i4),
   single_precision_output    = .false.,
/
</pre>
</div>
<p>
<code>limit_mem</code> can be used to limit how much of the state is read/written at once. 
It is for use with very large state vectors (e.g. 17GB) that cannot be read 
into one array.  Using this increases the number of communication calls during 
IO so it is only advisable to use this when your state vector size is 
approaching your total memory per node.  <code>limit_mem</code> is the number of elements 
to read/write and transpose in one step.  For example if you set 3000 element 
limit and had 3 variables of size 1000, 1500 and 1000. The 1500 element
variable and 1000 elmement variable would be read and transposed together, but 
the next 1000 element variable would be read and tranposed in a second step.
<p>
<code>single_precision_output</code> allows you to run filter in double precision but write 
NetCDF files in single presision
<p>


<h4>assim_tools_nml</h4>
<P>
<div class=namelist>
<pre>
&amp;assim_tools_nml
   distribute_mean  = .true.
/
</pre>
</div>
<p>
In previous DART releases, each processor gets a copy of the mean 
(in ens_mean_for_model).  In RMA DART, the mean is distributed across all 
processors.  However, a user can choose to have a copy of the mean on each 
processor by setting <code>distribute_mean = .false.</code> .  Note that the 
mean state is accessed through <code>get_state</code> whether distribute_mean 
is <code>.true.</code> or <code>.false.</code>

<H3> Removed from existing namelists </H3>
<pre>
&amp;filter_nml
   input_qc_threshold          = 3,
   outlier_threshold           = 4,
   enable_special_outlier_code = .false.
   start_from_restart          = .false.
   output_inflation            = .true.
   output_restart              = .true.
   /
</pre>
</div>

NOTE : <code>output_restart</code> has been renamed to 
<code>output_restarts</code>. <b><code>output_inflation</code> is no longer supported</b>
and only writes inflation files if <code>inf_flavor > 1</code>

<pre>
&amp;ensemble_manager_nml
   single_restart_file_out = .true.
   perturbation_amplitude  = 0.2,
   /
</pre>
</div>


<pre>
&amp;assim_manager_nml
   write_binary_restart_files = .true.,
   netCDF_large_file_support  = .false.
   /
</pre>
</div>

<!--==================================================================-->

<A NAME="Perturbations"></A>
<h2>Perturbations</h2>
The option to perturb one ensemble member to produce an ensemble is in 
filter_nml:<code>perturb_from_single_instance</code>. The model_mod interface 
is now <code>pert_model_copies</code> not <code>pert_model_state</code>. Each 
task perturbs every ensemble member for its own subsection of state.  This is 
more complicated than the Lanai routine <code>pert_model_state</code>, where a 
whole state vector is available. If a model_mod does not provide a perturb 
interface, filter will do the perturbing with an amplitude set in 
filter_nml:perturbation_amplitude. Note the perturb 
namelist options have been removed from ensemble_manager_nml


<!--==================================================================-->
<!-- Legalese & Metadata                                              -->
<!--==================================================================-->

<A NAME="Legalese"></A>
<div class="top">[<a href="#">top</a>]</div><hr />
<H2>Terms of Use</H2>

<P>
DART software - Copyright UCAR. This open source software is provided
by UCAR, "as is", without charge, subject to all terms of use at
<a href="http://www.image.ucar.edu/DAReS/DART/DART_download">
http://www.image.ucar.edu/DAReS/DART/DART_download</a>
</P>

<TABLE border=0 cellpadding=0 width=100% summary="">
<TR><TD valign=top>Contact:       </TD><TD> DART core group   </TD></TR>
<TR><TD>Revision:      </TD><TD> $Revision: 11299 $ </TD></TR>
<TR><TD>Source:        </TD><TD> $URL: https://svn-dares-dart.cgd.ucar.edu/DART/branches/rma_trunk/documentation/documentation/html/rma.html $ </TD></TR>
<TR><TD>Change Date:   </TD><TD> $Date: 2017-03-10 16:45:23 -0700 (Fri, 10 Mar 2017) $ </TD></TR>
<TR><TD valign=top>Change&nbsp;history:&nbsp;</TD><TD> try "svn&nbsp;log" or "svn&nbsp;diff" </TD></TR>
</TABLE>

<!--==================================================================-->

</BODY>
</HTML>
