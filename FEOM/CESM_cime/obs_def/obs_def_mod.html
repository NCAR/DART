<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
          "http://www.w3.org/TR/html4/strict.dtd">
<HTML>
<HEAD>
<TITLE>module obs_def_mod</TITLE>
<link rel="stylesheet" type="text/css" href="../doc/html/doc.css" />
<link href="../doc/images/dart.ico" rel="shortcut icon" />
</HEAD>
<BODY>
<A NAME="TOP"></A>

<H1>MODULE obs_def_mod</H1>

<table border=0 summary="" cellpadding=5>
<tr>
    <td valign=middle>
    <img src="../doc/images/Dartboard7.png" alt="DART project logo" height=70 />
    </td>
    <td>
       <P>Jump to <a href="../index.html">DART Documentation Main Index</a><br />
          <small><small>version information for this file: <br />
          <!-- version tag follows, do not edit -->
          $Id$</small></small>
       </P></td>
</tr>
</table>

<A HREF="#Interface">INTERFACES</A> /
<A HREF="#Namelist">NAMELIST</A> /
<A HREF="#FilesUsed">FILES</A> /
<A HREF="#References">REFERENCES</A> /
<A HREF="#Errors">ERRORS</A> /
<A HREF="#FuturePlans">PLANS</A> /
<A HREF="#PrivateComponents">PRIVATE COMPONENTS</A> /
<A HREF="#Legalese">TERMS OF USE</A>

<H2>Overview</H2>

<P>
The DART Fortran90 derived type <em class="unix">obs_def</em>
provide an abstraction of the definition of an observation.
An observation sequence <em class="unix">obs_seq</em>
at a higher level is composed of observation definitions associated
with observed values. For now, the basic operations required to implement an
observation definition are an ability to compute a forward operator given the
model state vector, the ability to read/write the observation definition
from/to a file, and a capability to do a standard input driven interactive
definition of the observation definition.
<br>
<br>
Beginning with the I-release of DART, a more flexible, powerful (and
complicated) mechanism for incorporating new types of observations is part
of DART. 
DART now makes a distinction between specific 
<em class="unix">observation types</em> and generic
<em class="unix">observation kinds</em>.  The role of the various
obs_def input files is to define the mapping between the types and kinds,
and optionally to provide type-specific processing routines.
<br>
<br>
A single obs_def output module is created by the program
<em class="unix">preprocess</em> from two kinds of input files. 
First, a DEFAULT obs_def module (normally called 
<em class="file">DEFAULT_obs_def_mod.F90</em> and documented
in this directory) is used as a template into which the preprocessor
incorporates information from zero or more special obs_def modules (such as
<em class="file">obs_def_1d_state_mod.f90</em> or 
<em class="file">obs_def_reanalysis_bufr_mod.f90</em>, also
documented in this directory).  
If no special obs_def files are included in the
preprocessor namelist, a minimal 
<em class="file">obs_def_mod.f90</em> is created which can only
support identity forward observation operators.
<br>
<br>
To add a new observation type which does not fit into any of the
already-defined obs_def files, a new file should be created in
the <em class="file">obs_def</em> directory.
These files are usually named according the the pattern 
<em class="file">obs_def_</em>X<em class="file">_mod.f90</em>,
where the X is either an instrument name, a data source, or a class
of observations.  See the existing filenames in that directory for ideas.
Then this new filename must be listed in the
<em class="file">input.nml</em> namelist for the model, in the
<em class="unix">&amp;preprocess_nml</em> section, in the
<em class="unix">input_files</em> variable.  This variable is a string
list type which can contain multiple filenames.  Running the
<em class="unix">preprocess</em> program will then use the contents
of the new file to generate the needed output files for use in linking
to the rest of the DART system.
</P>

<H3>Simple observations</H3>

<P>
If the new observation type can be directly interpolated by
a model_mod interpolation routine, and has no additional
observation-specific code for reading, writing, or initializing the
observation, then the entire contents of the new file is:
</P>
<pre>
! BEGIN DART PREPROCESS KIND LIST
! <em>type</em>, <em>kind</em>, COMMON_CODE
! <em>(repeat lines for each type)</em>
! END DART PREPROCESS KIND LIST
</pre>
<P>
DART will automatically generate all interface code needed for these
new observation types.  
For example, here is a real list:
</P>
<pre>
! BEGIN DART PREPROCESS KIND LIST
!VELOCITY,                     KIND_VELOCITY,              COMMON_CODE
!TRACER_CONCENTRATION,         KIND_TRACER_CONCENTRATION,  COMMON_CODE
!TRACER_SOURCE,                KIND_TRACER_SOURCE,         COMMON_CODE
!MEAN_SOURCE,                  KIND_MEAN_SOURCE,           COMMON_CODE
!SOURCE_PHASE,                 KIND_SOURCE_PHASE,          COMMON_CODE
! END DART PREPROCESS KIND LIST
</pre>
<P>
The first column is the specific observation
<em class="unix">type</em> and should be unique.  The second column
is the generic observation <em class="unix">kind</em> and must match
the list of known kinds in the
<em class="file">obs_kind_mod.f90</em>.  (To add a new kind, the
<em class="file">obs_kind/DEFAULT_obs_kind_mod.F90</em> file must be edited
to include a unique integer identifier for the kind.)
The third column must be the keyword
<em class="unix">COMMON_CODE</em> which tells the
<em class="unix">preprocess</em> program to automatically generate
all necessary interface code for this type.
</P>

<H3>Observations needing special handling</H3>

<P>
For observation types which have observation-specific routines,
must interpolate using a combination of other generic KINDs, or
require additional observation-specific data to be stored, the
following format is used:
</P>
<pre>
! BEGIN DART PREPROCESS KIND LIST
! <em>type</em>, <em>kind</em>
! <em>(repeat lines for each type/kind pair)</em>
! END DART PREPROCESS KIND LIST
</pre>
<P>
DART will need user-supplied interface code for each of the listed types.  
For example, here is a real list:
</P>
<pre>
! BEGIN DART PREPROCESS KIND LIST
! DOPPLER_RADIAL_VELOCITY, KIND_VELOCITY
! RADAR_REFLECTIVITY,      KIND_RADAR_REFLECTIVITY
! END DART PREPROCESS KIND LIST
</pre>
<P>
In this case, DART needs additional information for how to
process these types.  They include code sections delimited by
precisely formatted comments, and possibly module code sections:
</P>
<ol>
<li><pre>
! BEGIN DART PREPROCESS USE OF SPECIAL OBS_DEF MODULE
! END DART PREPROCESS USE OF SPECIAL OBS_DEF MODULE
</pre> 
Any fortran use statements for public subroutines or
variables from other modules should be placed between
these lines, with comment characters in the first column.
<br><br>
For example, if the forward operator code includes a module
then a use statement like:
<pre>
use obs_def_1d_state_mod, only : write_1d_integral, read_1d_integral, &amp;
                                 interactive_1d_integral, get_expected_1d_integral
</pre>
needs to be added to the obs_def_mod so the listed subroutines
are available to be called.
</li>

<li><pre>
! BEGIN DART PREPROCESS GET_EXPECTED_OBS_FROM_DEF
! END DART PREPROCESS GET_EXPECTED_OBS_FROM_DEF
</pre> 
These comments must enclose a case statement for
each defined type that returns the
expected observation value based on the current values
of the state vector.  
The code must be in comments,
with the comment character in the first column.
<br><br>
The variables available to be passed to subroutines or used
in this section of code are:
<table>
<tr><td><em class=code>state</em></td>
    <td>the entire model state vector</td></tr>
<tr><td><em class=code>state_time</em></td>
    <td>the time of the state data</td></tr>
<tr><td><em class=code>ens_index</em></td>
    <td>the ensemble member number</td></tr>
<tr><td><em class=code>location</em></td>
    <td>the observation location</td></tr>
<tr><td><em class=code>obs_kind_ind&nbsp;</em></td>
    <td>the index of the specific observation type</td></tr>
<tr><td><em class=code>obs_time</em></td>
    <td>the time of the observation</td></tr>
<tr><td><em class=code>error_val</em></td>
    <td>the observation error variance</td></tr>
</table>
<br>
The routine must fill in the values of these variables:
<table>
<tr><td><em class=code>obs_val&nbsp;</em></td>
    <td>the computed forward operator value </td></tr>
<tr><td><em class=code>istatus</em></td>
    <td>return code: 0=ok, >0 is error, <0 reserved for system use</td></tr>
</table>
<br>
To call a model_mod interpolate routine directly, the
argument list must match exactly:
<pre>
interpolate(state, location, KIND_xxx, obs_val, istatus)
</pre>
This can be useful if the forward operator needs to retrieve values
for fields which are typically found in a model and then compute
a derived value from them.

</li>

<li><pre>
! BEGIN DART PREPROCESS READ_OBS_DEF
! END DART PREPROCESS READ_OBS_DEF
</pre> 
These comments must enclose a case statement for
each defined type that reads any additional data 
associated with a single observation.
If there is no information beyond that for the
basic obs_def type, the case statement must still
be provided, but the code can simply be
<em class="unix">continue</em>.
The code must be in comments,
with the comment character in the first column.
<br><br>
The variables available to be passed to subroutines or used
in this section of code are:
<table>
<tr><td><em class=code>ifile</em></td>
    <td>the open unit number positioned ready to read, read-only</td></tr>
<tr><td><em class=code>obs_def&nbsp;</em></td>
    <td>the rest of the obs_def derived type for this obs, read-write</td></tr>
<tr><td><em class=code>key</em></td>
    <td>the index observation number in this sequence, read-only</td></tr>
<tr><td><em class=code>obs_val</em></td>
    <td>the observation value, if needed.  in general should not be changed</td></tr>
<tr><td><em class=code>is_ascii</em></td>
    <td>logical to indicate how the file was opened, formatted or unformatted</td></tr>
</table>
<br>
The usual use of this routine is to read in additional metadata
per observation and to set the private key in the <em class=code>obs_def</em>
to indicate which index to use for this observation to look up the
corresponding metadata in arrays or derived types.  Do not confuse
the key in the obs_def with the key argument to this routine; the latter
is the global observation sequence number for this observation.
</li>

<li><pre>
! BEGIN DART PREPROCESS WRITE_OBS_DEF
! END DART PREPROCESS WRITE_OBS_DEF
</pre> 
These comments must enclose a case statement for
each defined type that writes any additional data 
associated with a single observation.
If there is no information beyond that for the
basic obs_def type, the case statement must still
be provided, but the code can simply be
<em class="unix">continue</em>.
The code must be in comments,
with the comment character in the first column.
<br><br>
The variables available to be passed to subroutines or used
in this section of code are:
<table>
<tr><td><em class=code>ifile</em></td>
    <td>the open unit number positioned ready to write, read-only</td></tr>
<tr><td><em class=code>obs_def&nbsp;</em></td>
    <td>the rest of the obs_def derived type for this obs, read-only</td></tr>
<tr><td><em class=code>key</em></td>
    <td>the index observation number in this sequence, read-only</td></tr>
<tr><td><em class=code>is_ascii</em></td>
    <td>logical to indicate how the file was opened, formatted or unformatted</td></tr>
</table>
<br>
The usual use of this routine is to write the additional metadata
for this observation based on the private key 
in the <em class=code>obs_def</em>.  Do not confuse this with
the key in the subroutine call which is the observation number
relative to the entire observation sequence file.
</li>

<li><pre>
! BEGIN DART PREPROCESS INTERACTIVE_OBS_DEF
! END DART PREPROCESS INTERACTIVE_OBS_DEF
</pre> 
These comments must enclose a case statement for
each defined type that prompts the user for any
additional data associated
with a single observation.
If there is no information beyond that for the
basic obs_def type, the case statement must still
be provided, but the code can simply be
<em class="unix">continue</em>.
The code must be in comments,
with the comment character in the first column.
<br><br>
The variables available to be passed to subroutines or used
in this section of code are:
<table>
<tr><td><em class=code>obs_def&nbsp;</em></td>
    <td>the rest of the obs_def derived type for this obs, read-write</td></tr>
<tr><td><em class=code>key</em></td>
    <td>the index observation number in this sequence, read-only</td></tr>
</table>
<br>
The DART code will prompt for the rest of the obs_def values
(location, type, value, error) but any additional metadata needed
by this observation type should be prompted to, and read from,
the console (e.g. <em class=code>write(*,*)</em>, and 
<em class=code>read(*, *)</em>).  The code will generally set the 
<em class=code>obs_def%key</em> value as part of setting the metadata.
</li>

<li><pre>
! BEGIN DART PREPROCESS MODULE CODE
! END DART PREPROCESS MODULE CODE
</pre> 
If the code to process this observation requires
module data and/or subroutines, then these comments
must surround the module definitions.  Unlike all the
other sections, this comment pair is optional, and if
used, the code must not be in comments;
it will be copied verbatim over to the output file.
<br><br>
Generally the code for a forward operator should
be defined inside a module, to keep module variables
and other private subroutines from colliding with
unrelated routines and variables in other forward operator files.
</li>

</ol>

<P>
It is possible to mix automatic code types and user-supplied 
code types in the same list.  Simply add the COMMON_CODE keyword 
on the lines which need no special data or interfaces.
For example, here is an extract from the 1d state obs_def module,
where the raw state variable needs only autogenerated code, but
the 1d integral has user-supplied processing code:
</P>
<pre>
! BEGIN DART PREPROCESS KIND LIST
! RAW_STATE_VARIABLE,    KIND_RAW_STATE_VARIABLE, COMMON_CODE
! RAW_STATE_1D_INTEGRAL, KIND_1D_INTEGRAL
! END DART PREPROCESS KIND LIST


! BEGIN DART PREPROCESS USE OF SPECIAL OBS_DEF MODULE
!   use obs_def_1d_state_mod, only : write_1d_integral, read_1d_integral, &amp;
!                                    interactive_1d_integral, get_expected_1d_integral
! END DART PREPROCESS USE OF SPECIAL OBS_DEF MODULE

! BEGIN DART PREPROCESS GET_EXPECTED_OBS_FROM_DEF
!         case(RAW_STATE_1D_INTEGRAL)                                                         
!            call get_expected_1d_integral(state, location, obs_def%key, obs_val, istatus)  
! END DART PREPROCESS GET_EXPECTED_OBS_FROM_DEF

! BEGIN DART PREPROCESS READ_OBS_DEF
!      case(RAW_STATE_1D_INTEGRAL)
!         call read_1d_integral(obs_def%key, ifile, fileformat)
! END DART PREPROCESS READ_OBS_DEF

! BEGIN DART PREPROCESS WRITE_OBS_DEF
!      case(RAW_STATE_1D_INTEGRAL)
!         call write_1d_integral(obs_def%key, ifile, fileformat)
! END DART PREPROCESS WRITE_OBS_DEF

! BEGIN DART PREPROCESS INTERACTIVE_OBS_DEF
!      case(RAW_STATE_1D_INTEGRAL)
!         call interactive_1d_integral(obs_def%key)
! END DART PREPROCESS INTERACTIVE_OBS_DEF

! BEGIN DART PREPROCESS MODULE CODE
module obs_def_1d_state_mod

use        types_mod, only : r8
use    utilities_mod, only : register_module, error_handler, E_ERR, E_MSG
use     location_mod, only : location_type, set_location, get_location 
use  assim_model_mod, only : interpolate
use   cov_cutoff_mod, only : comp_cov_factor

implicit none

public :: write_1d_integral, read_1d_integral, interactive_1d_integral, &amp;
          get_expected_1d_integral

...  (module code here)

end module obs_def_1d_state_mod
! END DART PREPROCESS MODULE CODE
</pre>
<P>
See the <a href="obs_def_1d_state_mod.html">obs_def_1d_state_mod</a> 
documentation for more details and examples of each section.  Also see
<a href="obs_def_wind_speed_mod.f90">obs_def_wind_speed_mod.f90</a> for
an example of a 3D geophysical forward operator.
<br> <br>
In addition to collecting and managing any additional observation 
type-specific code, this module provides the definition of the
obs_def_type derived type, and a collection of subroutines for creating,
accessing, and updating this type.  The remainder of this document
describes the subroutines provided by this module.
</P>

<!--==================================================================-->

<A NAME="OtherModulesUsed"></A>
<div class="top">[<a href="#">top</a>]</div><hr />
<H2>OTHER MODULES USED</H2>
<PRE>
types_mod
utilities_mod
location_mod (depends on model choice)
time_manager_mod
assim_model_mod
obs_kind_mod
Other special obs_def_kind modules as required
</PRE>

<!--==================================================================-->
<!-- Declare all public entities ...                                  -->
<!-- duplicate public routines template as many times as necessary    -->
<!-- make sure you replace all yyyroutine?? strings                   -->
<!--==================================================================-->
<!--Note to authors. The first row of the table is different.         -->
<!--==================================================================-->

<A NAME="Interface"></A>
<div class="top">[<a href="#">top</a>]</div><hr />
<H2>PUBLIC INTERFACES</H2>

<TABLE>
<TR><TD><em class=call>use obs_def_mod, only : </em></TD>
                   <TD><A HREF="#obs_def_type">obs_def_type</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#init_obs_def">init_obs_def</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#get_obs_def_location">get_obs_def_location</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#get_obs_kind">get_obs_kind</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#get_obs_def_time">get_obs_def_time</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#get_obs_def_error_variance">get_obs_def_error_variance</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#get_obs_def_key">get_obs_def_key</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#set_obs_def_location">set_obs_def_location</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#set_obs_def_kind">set_obs_def_kind</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#set_obs_def_time">set_obs_def_time</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#set_obs_def_error_variance">set_obs_def_error_variance</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#set_obs_def_key">set_obs_def_key</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#interactive_obs_def">interactive_obs_def</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#write_obs_def">write_obs_def</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#read_obs_def">read_obs_def</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#get_expected_obs_from_def">get_expected_obs_from_def</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#destroy_obs_def">destroy_obs_def</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#copy_obs_def">copy_obs_def</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#copy_obs_def">assignment(=)</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#get_obs_name">get_obs_name</A></TD></TR>
</TABLE>

<P>
   A note about documentation style.
   Optional arguments are enclosed in brackets
   <em class=optionalcode>[like this]</em>.
</P>

<!--=================== DESCRIPTION OF A LOCAL TYPE ==================-->

<A NAME="obs_def_type"></A>
<br>
<div class=routine>
<pre>
<em class=call>type obs_def_type</em>
   private
   type(location_type)  :: location
   integer              :: kind
   type(time_type)      :: time
   real(r8)             :: error_variance
   integer              :: key
end type obs_def_type
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Models all that is known about an observation except for actual values.
Includes a location, kind, time and error variance.
</P>

<TABLE border=0 cellpadding=3 width=100%>

<TR><TH align=left>Component   </TH>
    <TH align=left>Description </TH></TR>
<TR><TD valign=top> location              </TD>
    <TD>Location of the observation.      </TD></TR>
<TR><TD valign=top> kind                  </TD>
    <TD>The kind of the observation.      </TD></TR>
<TR><TD valign=top> time                  </TD>
    <TD>Time of the observation.          </TD></TR>
<TR><TD valign=top> error_variance        </TD>
    <TD>Error variance of the observation.</TD></TR>
<TR><TD valign=top> key                   </TD>
    <TD>Unique identifier for observations of a particular kind.</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="init_obs_def"></A>
<br>
<div class=routine>
<em class=call> call init_obs_def(obs_def, location, kind, time, error_variance) </em>
<pre>
type(obs_def_type),  intent(out) :: <em class=code>obs_def</em>
type(location_type), intent(in)  :: <em class=code>location</em>
integer,             intent(in)  :: <em class=code>kind</em>
type(time_type),     intent(in)  :: <em class=code>time</em>
real(r8),            intent(in)  :: <em class=code>error_variance</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Creates an obs_def type with location, kind, time and error_variance
specified. 
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>obs_def&nbsp;&nbsp;</em></TD>
    <TD>The obs_def that is created</TD></TR>
<TR><TD valign=top><em class=code>location&nbsp;&nbsp;</em></TD>
    <TD>Location for this obs_def</TD></TR>
<TR><TD valign=top><em class=code>kind&nbsp;&nbsp;</em></TD>
    <TD>Observation kind for obs_def</TD></TR>
<TR><TD valign=top><em class=code>time&nbsp;&nbsp;</em></TD>
    <TD>Time for obs_def</TD></TR>
<TR><TD valign=top><em class=code>error_variance&nbsp;&nbsp;</em></TD>
    <TD>Error variance of this observation</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="copy_obs_def"></A>
<br>
<div class=routine>
<em class=call> call copy_obs_def(obs_def1, obs_def2) </em>
<pre>
type(obs_def_type), intent(out) :: <em class=code>obs_def1</em>
type(obs_def_type), intent(in)  :: <em class=code>obs_def2</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Copies obs_def2 to obs_def1, overloaded as assignment (=).
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>obs_def1&nbsp;&nbsp;</em></TD>
    <TD>obs_def to be copied into</TD></TR>
<TR><TD valign=top><em class=code>obs_def2&nbsp;&nbsp;</em></TD>
    <TD>obs_def to be copied from</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="get_obs_def_key"></A>
<br>
<div class=routine>
<em class=call> var = get_obs_def_key(obs_def) </em>
<pre>
integer                        :: <em class=code>get_obs_def_key</em>
type(obs_def_type), intent(in) :: <em class=code>obs_def</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Returns key from an observation definition.
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>var&nbsp;&nbsp;</em></TD>
    <TD>Returns key from an obs_def</TD></TR>
<TR><TD valign=top><em class=code>obs_def&nbsp;&nbsp;</em></TD>
    <TD>An obs_def</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->


<A NAME="get_obs_def_error_variance"></A>
<br>
<div class=routine>
<em class=call> var = get_obs_def_error_variance(obs_def) </em>
<pre>
real(r8)                       :: <em class=code>get_obs_def_error_variance</em>
type(obs_def_type), intent(in) :: <em class=code>obs_def</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Returns error variance from an observation definition.
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>var&nbsp;&nbsp;</em></TD>
    <TD>Error variance from an obs_def</TD></TR>
<TR><TD valign=top><em class=code>obs_def&nbsp;&nbsp;</em></TD>
    <TD>An obs_def</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="get_obs_def_location"></A>
<br>
<div class=routine>
<em class=call> var = get_obs_def_location(obs_def) </em>
<pre>
type(location_type)              :: <em class=code>get_obs_def_location</em>
type(obs_def_type), intent(in)   :: <em class=code>obs_def</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Returns the location from an observation definition. 
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>var&nbsp;&nbsp;</em></TD>
    <TD>Returns location from an obs_def</TD></TR>
<TR><TD valign=top><em class=code>obs_def&nbsp;&nbsp;</em></TD>
    <TD>An obs_def</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="get_obs_kind"></A>
<br>
<div class=routine>
<em class=call> var = get_obs_kind(obs_def) </em>
<pre>
integer                         :: <em class=code>get_obs_kind</em>
type(obs_def_type),  intent(in) :: <em class=code>obs_def</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Returns an observation kind from an observation definition.
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>var&nbsp;&nbsp;</em></TD>
    <TD>Returns the observation kind from an obs_def</TD></TR>
<TR><TD valign=top><em class=code>obs_def&nbsp;&nbsp;</em></TD>
    <TD>An obs_def</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="get_obs_def_time"></A>
<br>
<div class=routine>
<em class=call> var = get_obs_def_time(obs_def) </em>
<pre>
type(time_type)                :: <em class=code>get_obs_def_time</em>
type(obs_def_type), intent(in) :: <em class=code>obs_def</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Returns time from an observation definition.
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>var&nbsp;&nbsp;</em></TD>
    <TD>Returns time from an obs_def</TD></TR>
<TR><TD valign=top><em class=code>obs_def&nbsp;&nbsp;</em></TD>
    <TD>An obs_def</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="get_obs_name"></A>
<br>
<div class=routine>
<em class=call> obs_name = get_obs_name(obs_kind_ind) </em>
<pre>
character(len = 32)            :: <em class=code>get_obs_name</em>
integer, intent(in)            :: <em class=code>obs_kind_ind</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Returns an observation name from an observation kind.
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>var&nbsp;&nbsp;</em></TD>
    <TD>Returns name from an observation kind</TD></TR>
<TR><TD valign=top><em class=code>obs_kind_ind&nbsp;&nbsp;</em></TD>
    <TD>An observation kind</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="set_obs_def_location"></A>
<br>
<div class=routine>
<em class=call> call set_obs_def_location(obs_def, location) </em>
<pre>
type(obs_def_type),  intent(inout) :: <em class=code>obs_def</em>
type(location_type), intent(in)    :: <em class=code>location</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Set the location in an observation definition.
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>obs_def&nbsp;&nbsp;</em></TD>
    <TD>An obs_def</TD></TR>
<TR><TD valign=top><em class=code>location&nbsp;&nbsp;</em></TD>
    <TD>A location</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="set_obs_def_error_variance"></A>
<br>
<div class=routine>
<em class=call> call set_obs_def_error_variance(obs_def, error_variance) </em>
<pre>
type(obs_def_type), intent(inout) :: <em class=code>obs_def</em>
real(r8), intent(in)              :: <em class=code>error_variance</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Set error variance for an observation definition.
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>obs_def&nbsp;&nbsp;</em></TD>
    <TD>An obs_def</TD></TR>
<TR><TD valign=top><em class=code>error_variance&nbsp;&nbsp;</em></TD>
    <TD>Error variance</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="set_obs_def_key"></A>
<br>
<div class=routine>
<em class=call> call set_obs_def_key(obs_def, key) </em>
<pre>
type(obs_def_type), intent(inout) :: <em class=code>obs_def</em>
integer,            intent(in)    :: <em class=code>key</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Set the key for an observation definition.
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>obs_def&nbsp;&nbsp;</em></TD>
    <TD>An obs_def</TD></TR>
<TR><TD valign=top><em class=code>key&nbsp;&nbsp;</em></TD>
    <TD>Unique identifier for this observation</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="set_obs_def_kind"></A>
<br>
<div class=routine>
<em class=call> call set_obs_def_kind(obs_def, kind) </em>
<pre>
type(obs_def_type), intent(inout) :: <em class=code>obs_def</em>
integer,            intent(in)    :: <em class=code>kind</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Set the kind of observation in an observation definition.
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>obs_def&nbsp;&nbsp;</em></TD>
    <TD>An obs_def</TD></TR>
<TR><TD valign=top><em class=code>kind&nbsp;&nbsp;</em></TD>
    <TD>An integer observation kind</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="set_obs_def_time"></A>
<br>
<div class=routine>
<em class=call> call set_obs_def_time(obs_def, time) </em>
<pre>
type(obs_def_type), intent(inout) :: <em class=code>obs_def</em>
type(time_type), intent(in)       :: <em class=code>time</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Sets time for an observation definition.
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>obs_def&nbsp;&nbsp;</em></TD>
    <TD>An obs_def</TD></TR>
<TR><TD valign=top><em class=code>time&nbsp;&nbsp;</em></TD>
    <TD>Time to set</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="get_expected_obs_from_def"></A>
<br>
<div class=routine>
<em class=call> call get_expected_obs_from_def(key, obs_def, obs_kind_ind,
  ens_index, state, state_time, obs_val, istatus, 
  assimilate_this_ob, evaluate_this_ob) </em>
<pre>
integer,            intent(in)  :: <em class=code>key</em>
type(obs_def_type), intent(in)  :: <em class=code>obs_def</em>
integer,            intent(in)  :: <em class=code>obs_kind_ind</em>
integer,            intent(in)  :: <em class=code>ens_index</em>
real(r8),           intent(in)  :: <em class=code>state(:)</em>
type(time_type),    intent(in)  :: <em class=code>state_time</em>
real(r8),           intent(out) :: <em class=code>obs_val</em>
integer,            intent(out) :: <em class=code>istatus</em>
logical,            intent(out) :: <em class=code>assimilate_this_ob</em>
logical,            intent(out) :: <em class=code>evaluate_this_ob</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Compute the observation (forward) operator for a particular obs definition.
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>key&nbsp;&nbsp;</em></TD>
    <TD>descriptor for observation type</TD></TR>
<TR><TD valign=top><em class=code>obs_def&nbsp;&nbsp;</em></TD>
    <TD>The input obs_def</TD></TR>
<TR><TD valign=top><em class=code>obs_kind_ind&nbsp;&nbsp;</em></TD>
    <TD>The obs kind</TD></TR>
<TR><TD valign=top><em class=code>ens_index&nbsp;&nbsp;</em></TD>
    <TD>The ensemble member number of this state vector</TD></TR>
<TR><TD valign=top><em class=code>state&nbsp;&nbsp;</em></TD>
    <TD>Model state vector</TD></TR>
<TR><TD valign=top><em class=code>state_time&nbsp;&nbsp;</em></TD>
    <TD>Time of the data in the model state vector</TD></TR>
<TR><TD valign=top><em class=code>istatus&nbsp;&nbsp;</em></TD>
    <TD>Returned integer describing problems with applying forward 
        operator (0 == OK, >0 == error, <0 reserved for sys use).</TD></TR>
<TR><TD valign=top><em class=code>assimilate_this_ob&nbsp;&nbsp;</em></TD>
    <TD>Indicates whether to assimilate this obs or not</TD></TR>
<TR><TD valign=top><em class=code>evaluate_this_ob&nbsp;&nbsp;</em></TD>
    <TD>Indicates whether to evaluate this obs or not</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="read_obs_def"></A>
<br>
<div class=routine>
<em class=call> call read_obs_def(ifile, obs_def, key, obs_val
    <em class=optionalcode>[,fform]</em>) </em>
<pre>
integer,                    intent(in)    :: <em class=code>ifile</em>
type(obs_def_type),         intent(inout) :: <em class=code>obs_def</em>
integer,                    intent(in)    :: <em class=code>key</em>
real(r8),                   intent(inout) :: <em class=code>obs_val</em>
character(len=*), optional, intent(in)    :: <em class=code>fform</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Reads an obs_def from file open on channel ifile. Uses format specified
in fform or FORMATTED if fform is not present. 
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>ifile&nbsp;&nbsp;</em></TD>
    <TD>File unit open to output file</TD></TR>
<TR><TD valign=top><em class=code>obs_def&nbsp;&nbsp;</em></TD>
    <TD>Observation definition to be read</TD></TR>
<TR><TD valign=top><em class=code>key&nbsp;&nbsp;</em></TD>
    <TD>Present if unique identifier key is needed by some obs kind.  
        Unused by default code.</TD></TR>
<TR><TD valign=top><em class=code>obs_val&nbsp;&nbsp;</em></TD>
    <TD>Present if needed to perform operations based on value.
        Unused by default code.</TD></TR>
<TR><TD valign=top><em class=code>fform&nbsp;&nbsp;</em></TD>
    <TD>File format specifier: FORMATTED or UNFORMATTED; default FORMATTED
         (FORMATTED in this case is the human readable/text 
          option as opposed to UNFORMATTED which is binary.)</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="interactive_obs_def"></A>
<br>
<div class=routine>
<em class=call> call interactive_obs_def(obs_def, key) </em>
<pre>
type(obs_def_type), intent(inout) :: <em class=code>obs_def</em>
integer,            intent(in)    :: <em class=code>key</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Creates an obs_def via input from standard in. 
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>obs_def&nbsp;&nbsp;</em></TD>
    <TD>An obs_def to be created</TD></TR>
<TR><TD valign=top><em class=code>key&nbsp;&nbsp;</em></TD>
    <TD>Present if unique identifier key is needed by some obs kind.
        Unused by default code.</TD></TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="write_obs_def"></A>
<br>
<div class=routine>
<em class=call> call write_obs_def(ifile, obs_def, key
    <em class=optionalcode>[,fform]</em>) </em>
<pre>
integer,                    intent(in) :: <em class=code>ifile</em>
type(obs_def_type),         intent(in) :: <em class=code>obs_def</em>
integer,                    intent(in) :: <em class=code>key</em>
character(len=*), optional, intent(in) :: <em class=code>fform</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Writes an obs_def to file open on channel ifile. Uses format specified
in fform or FORMATTED if fform is not present. 
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>ifile&nbsp;&nbsp;</em></TD>
    <TD>File unit open to output file</TD></TR>
<TR><TD valign=top><em class=code>obs_def&nbsp;&nbsp;</em></TD>
    <TD>Observation definition to be written</TD></TR>
<TR><TD valign=top><em class=code>key&nbsp;&nbsp;</em></TD>
    <TD>Present if unique identifier key is needed by some obs kind.
        Unused by default code.</TD></TR>
<TR><TD valign=top><em class=code>fform&nbsp;&nbsp;</em></TD>
    <TD>File format specifier: FORMATTED or UNFORMATTED; default FORMATTED</TD>
</TR>
</TABLE>

</div>
<br>

<!--===================== DESCRIPTION OF A ROUTINE =====================-->

<A NAME="destroy_obs_def"></A>
<br>
<div class=routine>
<em class=call> call destroy_obs_def(obs_def) </em>
<pre>
type(obs_def_type), intent(inout) :: <em class=code>obs_def</em>
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>
Releases all storage associated with an obs_def and its subcomponents. 
</P>

<TABLE width=100% border=0 summary="" cellpadding=3>
<TR><TD valign=top><em class=code>obs_def&nbsp;&nbsp;</em></TD>
    <TD>An obs_def to be released.</TD></TR>
</TABLE>

</div>
<br>

<!--==================================================================-->
<!-- Describe the Files Used by this module.                          -->
<!--==================================================================-->

<A NAME="FilesUsed"></A>
<div class="top">[<a href="#">top</a>]</div><hr />
<H2>FILES</H2>
<UL><LI>The read_obs_def() and write_obs_def() routines 
are passed an already-opened file channel/descriptor
and read to or write from it.
</UL>

<!--==================================================================-->
<!-- Cite references, if need be.                                     -->
<!--==================================================================-->

<A NAME="References"></A>
<div class="top">[<a href="#">top</a>]</div><hr />
<H2>REFERENCES</H2>
<ul>
<li> none </li>
</ul>

<!--==================================================================-->
<!-- Describe all the error conditions and codes.                     -->
<!--==================================================================-->

<A NAME="Errors"></A>
<div class="top">[<a href="#">top</a>]</div><hr />
<H2>ERROR CODES and CONDITIONS</H2>
<div class=errors>
<TABLE border=1 cellspacing=1 cellpadding=10 width=100%>
<TR><TH>Routine</TH><TH>Message</TH><TH>Comment</TH></TR>

<TR><!-- routine --><TD VALIGN=top>get_expected_obs_from_def</TD>
    <!-- message --><TD VALIGN=top>Attempt to evaluate undefined observation kind</TD>
    <!-- comment --><TD VALIGN=top>An observation kind for which
     no forward operator has been defined is an error.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>read_obs_def</TD>
    <!-- message --><TD VALIGN=top>Expected header "obdef" in input file</TD>
    <!-- comment --><TD VALIGN=top>The format of the input file is not consistent.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>read_obs_def</TD>
    <!-- message --><TD VALIGN=top>Expected kind header "kind " in input file</TD>
    <!-- comment --><TD VALIGN=top>The format of the input file is not consistent.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>read_obs_def</TD>
    <!-- message --><TD VALIGN=top>Attempt to read for undefined obs_kind index</TD>
    <!-- comment --><TD VALIGN=top>Reading for an observation kind for which
     no forward operator has been defined is an error.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>write_obs_def</TD>
    <!-- message --><TD VALIGN=top>Attempt to write for undefined obs_kind index</TD>
    <!-- comment --><TD VALIGN=top>Writing for an observation kind for which
     no forward operator has been defined is an error.</TD>
</TR>

<TR><!-- routine --><TD VALIGN=top>interactive_obs_def</TD>
    <!-- message --><TD VALIGN=top>Attempt to  interactively create undefined obs_kind index</TD>
    <!-- comment --><TD VALIGN=top>Creating an observation kind for which
     no forward operator has been defined is an error.</TD>
</TR>

</TABLE>
</div>

<H2>KNOWN BUGS</H2>
<P>
none at this time
</P>

<!--==================================================================-->
<!-- Describe Future Plans.                                           -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<div class="top">[<a href="#">top</a>]</div><hr />
<H2>FUTURE PLANS</H2>
<P>
none at this time
</P>

<!--==================================================================-->
<!-- PrivateComponents                                                -->
<!--==================================================================-->

<A NAME="PrivateComponents"></A>
<div class="top">[<a href="#">top</a>]</div><hr />
<H2>PRIVATE COMPONENTS</H2>
<P>
N/A
</P>

<!--==================================================================-->
<!-- Legalese & Metadata                                              -->
<!--==================================================================-->

<A NAME="Legalese"></A>
<div class="top">[<a href="#">top</a>]</div><hr />
<H2>Terms of Use</H2>

<P>
DART software - Copyright 2004 - 2013 UCAR.<br>
This open source software is provided by UCAR, "as is",<br>
without charge, subject to all terms of use at<br>
<a href="http://www.image.ucar.edu/DAReS/DART/DART_download">
http://www.image.ucar.edu/DAReS/DART/DART_download</a>
</P>

<TABLE border=0 cellpadding=0 width=100% summary="">
<TR><TD valign=top>Contact:       </TD><TD> DART core group   </TD></TR>
<TR><TD valign=top>Revision:      </TD><TD> $Revision$ </TD></TR>
<TR><TD valign=top>Source:        </TD><TD> $URL$ </TD></TR>
<TR><TD valign=top>Change Date:   </TD><TD> $Date$ </TD></TR>
<TR><TD valign=top>Change&nbsp;history:&nbsp;</TD><TD> try "svn&nbsp;log" or "svn&nbsp;diff" </TD></TR>
</TABLE>

<!--==================================================================-->

</BODY>
</HTML>
