[](#TOP)

MODULE random\_seq\_mod
=======================

  ------------------------------------------------------------------------ -------------------------------------------------------------------
  ![DART project logo](../../../docs/images/Dartboard7.png){height="70"}   Jump to [DART Documentation Main Index](../../../docs/index.html)
  ------------------------------------------------------------------------ -------------------------------------------------------------------

[INTERFACES](#Interface) / [NAMELIST](#Namelist) / [FILES](#FilesUsed) /
[REFERENCES](#References) / [ERRORS](#Errors) / [PLANS](#FuturePlans) /
[PRIVATE COMPONENTS](#PrivateComponents) / [TERMS OF USE](#Legalese)

Overview
--------

Provides access to any number of reproducible random sequences. Can
sample from uniform, gaussian, two-dimensional gaussian, gamma, inverse
gamma, and exponential distributions.

The current random sequence generator is a Fortran version of the [GNU
Library](http://www.gnu.org/software/gsl/) implementation of the
[Mersenne Twister](http://en.wikipedia.org/wiki/Mersenne_twister)
algorithm. The original code is in the C language and the conversion to
Fortran was done by the DART team.

There are test programs in the *developer\_tests/random\_seq* directory
which show examples of calling these routines. Build and run these tests
in the *test* subdirectory.

Use within Dart
-------------

One of the design goals of the DART software when random numbers are used, is that the generator should be seeded so running the same program again on the same input data produces the same results.  This allows differences in results to be attributed to changes in the input data or settings, not changes in the random number sequence.  

There are several strategies for selecting a seed depending on how the random sequence of values will be used.  

Constant value:

Setting a constant seed guarantees the results will be reproducible and is the simplest to code.  This should be used when the program results will be compared only to other values generated by the same run of this program, not between different runs of the program.  For example, a constant should not be used if the results of a run will be compared to runs on other ensemble members or runs with data from other model times.

Ensemble member number:

If the ensemble member number is available it is often a good choice for the seed value, to guarantee that different members will use different random sequences.  For our MPI-enabled programs, this strategy should be used when a single task handles all the work for any single ensemble member.  If the work for an ensemble member is spread across multiple tasks, see below for 'both ensemble member and task number'.  

Task number:

If the code using random numbers is part of a parallel program, then usually each task needs to set a different seed to generate different sequences of values in each task.  If the task number is used as the seed the results will be reproducible as long as the number of tasks in the job is held constant.  There are several places in the DART code where it does not have access to the model time or the ensemble number at the place where the seed must be set.  In this case, the best it can do is to use the task number or a value based on the task number, and document that to get entirely reproducible results the user must keep the task count constant.   The DART routine *mpi_utilities_mod::my_task_id()* is available to return the current task number.  Note that task numbers follow the MPI standard of starting with 0.  

Both ensemble member and task number:

If the ensemble number and the task number are available, they can be combined to generate different random sequences.  This is needed, for example, when a task only has part of an ensemble member's state and needs to perturb it with random values.  Some care must be taken when combining the numbers to ensure that the combination is unique.  For example, one formula used is of the form: (100000 * task_number) + ensemble_member_number.  This creates unique numbers for any case using less than 100,000 ensemble members (a fairly safe guess).

Model/State timestamp:

If you are running the same program but with different input data and the random sequence should be different for each invocation of the program, there is a time manager routine, *time_manager_mod::generate_seed()* that generates a reproducible seed given a dart *time_type*.  For example, this strategy is used in the *perfect_model_obs* program to initialize the random sequence of draws from a gaussian distribution to add noise to synthetic observations. If a constant seed was used the same noise values would be added to the observations each time the program was run, even if the input model data was different, potentially generating duplicate series of noise values for each run.  So this program uses the timestamp of the input model data to set the seed, resulting in reproducible random sequences that are different for a series of invocations.


\[[top](#)\]


------------------------------------------------------------------------
[](#OtherModulesUsed)
OTHER MODULES USED
------------------

    types_mod
    utilities_mod


\[[top](#)\]


------------------------------------------------------------------------
[](#Interface)
PUBLIC INTERFACES
-----------------

  -------------------------------- ---------------------------------------------------------
  *use random\_seq\_mod, only :*   [random\_seq\_type](#random_seq_type)
                                   [init\_random\_seq](#init_random_seq)
                                   [random\_uniform](#random_uniform)
                                   [random\_gaussian](#random_gaussian)
                                   [several\_random\_gaussians](#several_random_gaussians)
                                   [twod\_gaussians](#twod_gaussians)
                                   [random\_gamma](#random_gamma)
                                   [random\_inverse\_gamma](#random_inverse_gamma)
                                   [random\_exponential](#random_exponential)
  -------------------------------- ---------------------------------------------------------

A note about documentation style. Optional arguments are enclosed in
brackets *\[like this\]*.

[](#random_seq_type)

<div class="routine">

    type random_seq_type
       private

       integer     :: mti
       integer(i8) :: mt(624)
       real(r8)    :: lastg
       logical     :: gset

    end type random_seq_type

</div>

<div class="indent1">

This type is used to uniquely identify a sequence. Keeps the state
history of the linear congruential number generator. In this
implementation it is based on the Mersenne Twister from the GNU
Scientific Library.

</div>


[](#init_random_seq)

<div class="routine">

    call init_random_seq(r [ , seed] )

    type(random_seq_type),           intent(inout) :: r
    integer,               optional, intent(in)    :: seed

</div>

<div class="indent1">

Initializes a random sequence for use. This must be called before any
random numbers can be generated from this sequence. Any number of
independent, reproducible random sequences can be generated by having
multiple instances of a random\_seq\_type. A specified integer seed,
optional, can produce a specific 'random' sequence.

  | arg    | description                               |
  |--------|-------------------------------------------|
  | *r*    |  A random sequence type to be initialized.|
  | *seed* |  A seed for a random sequence.            |


</div>


[](#random_uniform)

<div class="routine">

    var = random_uniform(r)

    real(r8)                             :: random_uniform
    type(random_seq_type), intent(inout) :: r

</div>

<div class="indent1">

Returns a random draw from a uniform distribution on interval \[0,1\].

  ------------------- ---------------------------------------------------
  *random\_uniform*   A random draw from a Uniform\[0,1\] distribution.
  *r*                 An initialized random sequence type.
  ------------------- ---------------------------------------------------

</div>

\
[](#random_gaussian)\

<div class="routine">

*var = random\_gaussian(r, mean, standard\_deviation)*
    real(r8)                             :: random_gaussian
    type(random_seq_type), intent(inout) :: r
    real(r8),              intent(in)    :: mean
    real(r8),              intent(in)    :: standard_deviation

</div>

<div class="indent1">

Returns a random draw from a Gaussian distribution with the specified
mean and standard deviation.

See [this Wikipedia
page](https://en.wikipedia.org/wiki/Normal_distribution) for more
explanation about this function.

  ----------------------- ---------------------------------------------
  *random\_gaussian*      A random draw from a gaussian distribution.
  *r*                     An initialized random sequence type.
  *mean*                  Mean of the gaussian.
  *standard\_deviation*   Standard deviation of the gaussian.
  ----------------------- ---------------------------------------------

</div>

\
[](#several_random_gaussians)\

<div class="routine">

*call several\_random\_gaussians(r, mean, standard\_deviation, n, rnum)*
    type(random_seq_type),  intent(inout) :: r
    real(r8),               intent(in)    :: mean
    real(r8),               intent(in)    :: standard_deviation
    integer,                intent(in)    :: n
    real(r8), dimension(:), intent(out)   :: rnum

</div>

<div class="indent1">

Returns *n* random samples from a gaussian distribution with the
specified mean and standard deviation. Array *rnum* must be at least
size *n*.

  ----------------------- --------------------------------------
  *r*                     An initialized random sequence type.
  *mean*                  Mean of the Gaussian to be sampled.
  *standard\_deviation*   Standard deviation of the Gaussian.
  *n*                     Number of samples to return
  *rnum*                  The random samples of the Gaussian.
  ----------------------- --------------------------------------

</div>

\
[](#twod_gaussians)\

<div class="routine">

*call twod\_gaussians(r, mean, cov, rnum)*
    type(random_seq_type),    intent(inout) :: r
    real(r8), dimension(2),   intent(in)    :: mean
    real(r8), dimension(2,2), intent(in)    :: cov
    real(r8), dimension(2),   intent(out)   :: rnum

</div>

<div class="indent1">

Returns a random draw from a 2D gaussian distribution with the specified
mean and covariance.

The algorithm used is from Knuth, exercise 13, section 3.4.1. See [this
Wikipedia
page](https://en.wikipedia.org/wiki/Multivariate_normal_distribution)
for more explanation about this function.

  -------- --------------------------------------
  *r*      An initialized random sequence type.
  *mean*   Mean of 2D gaussian distribution.
  *cov*    Covariance of 2D gaussian.
  *rnum*   Returned random draw from gaussian.
  -------- --------------------------------------

</div>

\
[](#random_gamma)\

<div class="routine">

*var = random\_gamma(r, rshape, rscale)*
    real(r8)                             :: random_gamma
    type(random_seq_type), intent(inout) :: r
    real(r8),              intent(in)    :: rshape
    real(r8),              intent(in)    :: rscale

</div>

<div class="indent1">

Returns a random draw from a Gamma distribution with specified *rshape*
and *rscale*. Both must be positive.

Note that there are three different parameterizations in common use:

1.  With shape parameter κ (kappa) and scale parameter θ (theta).
2.  With shape parameter α (alpha) and rate parameter β (beta). Alpha is
    the same as kappa, and beta is an inverse scale parameter so β =
    1/θ.
3.  With shape parameter κ (kappa) and mean parameter μ (mu). μ = κ/β,
    so β = κ/μ.

This form uses the first parameterization, shape (κ) and scale (θ). The
distribution mean is κθ and the variance is κ(θ²).
This routine is based on the Gamma(a,b) generator from the GNU
Scientific library. See [this Wikipedia
page](https://en.wikipedia.org/wiki/Gamma_distribution) for more
explanation of the various parameterizations of this function.

  ----------------- ----------------------------------------------------------------------------------------------------------------
  *random\_gamma*   A random draw from a gamma distribution.
  *r*               An initialized random sequence type.
  *rshape*          Shape parameter. Often written as either alpha or kappa.
  *rscale*          Scale parameter. Often written as theta. If you have a rate parameter (often beta) pass in (1/rate) for scale.
  ----------------- ----------------------------------------------------------------------------------------------------------------

</div>

\
[](#random_inverse_gamma)\

<div class="routine">

*var = random\_inverse\_gamma(r, rshape, rscale)*
    real(r8)                             :: random_inverse_gamma
    type(random_seq_type), intent(inout) :: r
    real(r8),              intent(in)    :: rshape
    real(r8),              intent(in)    :: rscale

</div>

<div class="indent1">

Returns a random draw from an inverse Gamma distribution with the
specified *shape* and *scale*. Both must be positive. If you have 'rate'
instead of 'scale' pass in (1/rate) for scale.

See [this Wikipedia
page](https://en.wikipedia.org/wiki/Inverse-gamma_distribution) for more
explanation about this function.

  -------------------------- ----------------------------------------------------------------------------------------------------------------
  *random\_inverse\_gamma*   A random draw from an inverse gamma distribution.
  *r*                        An initialized random sequence type.
  *rshape*                   Shape parameter. Often written as either alpha or kappa.
  *rscale*                   Scale parameter. Often written as theta. If you have a rate parameter (often beta) pass in (1/rate) for scale.
  -------------------------- ----------------------------------------------------------------------------------------------------------------

</div>

\
[](#random_exponential)\

<div class="routine">

*var = random\_exponential(r, rate)*
    real(r8)                             :: random_exponential
    type(random_seq_type), intent(inout) :: r
    real(r8),              intent(in)    :: rate

</div>

<div class="indent1">

Returns a random draw from an exponential distribution with the
specified *rate*. If you have a scale parameter (which is the same as
the mean, the standard deviation, and the survival parameter), specify
(1/scale) for rate.

See [this Wikipedia
page](https://en.wikipedia.org/wiki/Exponential_distribution) for more
explanation about this function.

  ----------------------- ----------------------------------------------------------------------------------------------------
  *random\_exponential*   A random draw from an exponential distribution.
  *r*                     An initialized random sequence type.
  *rate*                  Rate parameter. Often written as lambda. If you have a scale parameter pass in (1/scale) for rate.
  ----------------------- ----------------------------------------------------------------------------------------------------

</div>

\
[](#Namelist)

<div class="top">

\[[top](#)\]

</div>

------------------------------------------------------------------------

NAMELIST
--------

This module has no namelist input.

[](#FilesUsed)

<div class="top">

\[[top](#)\]

</div>

------------------------------------------------------------------------

FILES
-----

-   NONE

[](#References)

<div class="top">

\[[top](#)\]

</div>

------------------------------------------------------------------------

REFERENCES
----------

1.  Knuth, Vol 2.
2.  [GNU Scientific Library Reference
    Manual](http://www.gnu.org/software/gsl/manual/html_node/Random-Number-Generation.html)

[](#Errors)

<div class="top">

\[[top](#)\]

</div>

------------------------------------------------------------------------

ERROR CODES and CONDITIONS
--------------------------

<div class="errors">

Routine
Message
Comment
 
 
 

</div>

KNOWN BUGS
----------

none at this time

[](#FuturePlans)

<div class="top">

\[[top](#)\]

</div>

------------------------------------------------------------------------

FUTURE PLANS
------------

none at this time

[](#PrivateComponents)

<div class="top">

\[[top](#)\]

</div>

------------------------------------------------------------------------

PRIVATE COMPONENTS
------------------

  --- --------------------------
      [init\_ran](#init_ran)
      [ran\_unif](#ran_unif)
      [ran\_gauss](#ran_gauss)
      [ran\_gamma](#ran_gamma)
  --- --------------------------

[](#init_ran)\

<div class="routine">

*call init\_ran(s, seed)*
    type(random_seq_type), intent(out) :: s
    integer,               intent(in)  :: seed

</div>

<div class="indent1">

Initializes a random sequence with an integer. Any sequence initialized
with the same integer will produce the same sequence of pseudo-random
numbers.

  -------- ----------------------------------------
  *s*      A random sequence to be initialized
  *seed*   An integer seed to start the sequence.
  -------- ----------------------------------------

</div>

\
[](#ran_unif)\

<div class="routine">

*var = ran\_unif(s)*
    real(r8)                             :: ran_unif
    type(random_seq_type), intent(inout) :: s

</div>

<div class="indent1">

Generate the next uniform \[0, 1\] random number in the sequence.

  ------------- ---------------------------------------------------------
  *ran\_unif*   Next uniformly distributed \[0, 1\] number in sequence.
  *s*           A random sequence.
  ------------- ---------------------------------------------------------

</div>

\
[](#ran_gauss)\

<div class="routine">

*var = ran\_gauss(s)*
    real(r8)                             :: ran_gauss
    type(random_seq_type), intent(inout) :: s

</div>

<div class="indent1">

Generates a random draw from a standard gaussian.

  -------------- -----------------------------------------
  *ran\_gauss*   A random draw from a standard gaussian.
  *s*            A random sequence.
  -------------- -----------------------------------------

</div>

\
[](#ran_gamma)\

<div class="routine">

*var = ran\_gamma(r, rshape, rscale)*
    real(r8)                             :: ran_gamma
    type(random_seq_type), intent(inout) :: r
    real(r8),              intent(in)    :: rshape
    real(r8),              intent(in)    :: rscale

</div>

<div class="indent1">

Generates a random draw from a Gamma distribution. See notes in the
[random\_gamma()](#random_gamma) section about (alpha,beta) vs
(kappa,theta) vs (kappa,mu) parameterizations. This is transcribed from
C code in the GNU Scientific library and keeps the (shape,scale)
interface.

  -------------- -------------------------------------------------------------
  *ran\_gamma*   A random draw from a Gamma distribution.
  *r*            A random sequence.
  *rshape*       Shape parameter.
  *rscale*       Scale parameter. (This is the inverse of a rate parameter.)
  -------------- -------------------------------------------------------------

</div>

\
[](#Legalese)

<div class="top">

\[[top](#)\]

</div>

------------------------------------------------------------------------

Terms of Use
------------

DART software - Copyright UCAR. This open source software is provided by
UCAR, "as is", without charge, subject to all terms of use at
<http://www.image.ucar.edu/DAReS/DART/DART_download>
