<!--
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!                                                                       !!
!!                   GNU General Public License                          !!
!!                                                                       !!
!! This file is part of the Data Assimilation Research Testbed (DART).   !!
!!                                                                       !!
!! DART is free software; you can redistribute it and/or modify          !!
!! it and are expected to follow the terms of the GNU General Public     !!
!! License as published by the Free Software Foundation.                 !!
!!                                                                       !!
!! DART is distributed in the hope that it will be useful,               !!
!! but WITHOUT ANY WARRANTY; without even the implied warranty of        !!
!! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         !!
!! GNU General Public License for more details.                          !!
!!                                                                       !!
!! You should have received a copy of the GNU General Public License     !!
!! along with DART; if not, write to:                                    !!
!!          Free Software Foundation, Inc.                               !!
!!          59 Temple Place, Suite 330                                   !!
!!          Boston, MA  02111-1307  USA                                  !!
!! or see:                                                               !!
!!          http://www.gnu.org/licenses/gpl.txt                          !!
!!                                                                       !!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-->

<HTML>
<TITLE>module obs_def_1d_state_mod</TITLE>
<link rel=stylesheet type=text/css href=../doc/html/doc.css>
<BODY>

<DIV ALIGN=CENTER>
<A HREF="#Interface">INTERFACE</A> / 
<A HREF="#PublicEntities">PUBLIC COMPONENTS</A> / 
<A HREF="#Namelist">NAMELIST</A> / 
<A HREF="#FilesUsed">FILES</A> /
<A HREF="#References">REFERENCES</A> /
<A HREF="#Errors">ERRORS</A> /
<A HREF="#KnownBugs">BUGS</A> /
<A HREF="#FuturePlans">PLANS</A> /
</DIV>

<!--==================================================================-->

<H1>MODULE obs_def_1d_state_mod</H1>
<A NAME="HEADER"></A>
<TABLE summary="">
   <TR><TD>Contact:       </TD><TD> Jeff Anderson                </TD></TR>
   <TR><TD>Reviewers:     </TD><TD> &nbsp;                       </TD></TR>
   <TR><TD>Revision:      </TD><TD> $Revision$             </TD></TR>
   <TR><TD>Release Name:  </TD><TD> $Name$                       </TD></TR>
   <TR><TD>Change Date:   </TD><TD> $Date$ </TD></TR>
   <TR><TD>Change history:</TD><TD> see CVS log                  </TD></TR>
</TABLE>

<!--==================================================================-->

<A NAME="OVERVIEW"></A>
<HR>
<H2>OVERVIEW</H2>
<P>
Beginning with the I-release of DART, a more flexible. powerful (and complicated)
mechanism for incorporating new types of observations is part of DART. The
speical obs_def module being described here is used by the program preprocess.f90
to insert appropriate code sections into a DEFAULT_obs_def module and a 
DEFAULT_obs_kind module to generate the obs_def_mod.f90 and obs_kind_mod.f90
that are used by filer programs.

<P>
This is an extended format Fortran90 module that provides the definition
for observation types designed for use with idealized low-order models
that use the 1D location module and can be thought of as having a state
vector that is equally spaced on a 1D cyclic domain. The two observation types
are: a straight linear interpolation to a point on a [0,1] domain called
a RAW_STATE_VARIABLE; an area-weighted 'integral' of the state variable
over some part of the cylic 1D domain. The second type can be used to
do idealized studies related to remote sensing observations that are
best thought of as weighted integrals of some quantity over a finite volume.

<P> The second observation type is referred to as a RAW_STATE_1D_INTEGRAL. It
has an associated half_width and localization type (see cov_cutoff module)
and a number of points at which to compute the associated integral by 
quadrature. The location of the observation defines the center of mass of
the integral. The integral is centered around the location and extends
outward on each side to 2*half_width. The weight associated with the
integral is defined by the weight of the localization function (for
instance Gaspari Cohn) selected by the localization in the cov_cutoff
module. The number of points are used to equally divide the range for
computing the integral by quadrature.

<P> This module was partly motivated to provide a prototype for those
developing more complicated specialized observation definition modules.
Special observation modules like this contain Fortran90 code PLUS additional
specially formatted commented code that is used to guide the preprocessor
in constructing the obs_def_mod.f90 and obs_kind_mod.f90. These specially
formatted comments are most conveniently placed at the beginning of the module
and comprise six sections, each beginning and ending with a special F90
comment line that must be included VERBATIM. The six sections and there
specific instance for the 1d_raw_state_mod are:

<P>
1. A list of all observation kinds defined by this module and their associated
generic kinds (see obs_kind module). The header line is followed by lines
that have the observation kind name (an all caps Fortran 90 identifier) and
their associated generic kind identifier from the obs_kind module.<BR>
<P>
! BEGIN DART PREPROCESS KIND LIST <BR>
! RAW_STATE_VARIABLE,    KIND_RAW_STATE_VARIABLE <BR>
! RAW_STATE_1D_INTEGRAL, KIND_1D_INTEGRAL <BR>
! END DART PREPROCESS KIND LIST <BR>

<P>
2. A list of all the use statements that the completed obs_def_mod.f90
must have in order to use the public interfaces provided by this special
obs_def module. <BR>
<P>
! BEGIN DART PREPROCESS USE OF SPECIAL OBS_DEF MODULE <BR>
!   use obs_def_1d_state_mod, only : write_1d_integral, read_1d_integral, 
!                                     interactive_1d_integral, get_expected_1d_integral <BR>
! END DART PREPROCESS USE OF SPECIAL OBS_DEF MODULE <BR>

<P>
3. Case statement entries for each observation kind defined by this special
obs_def module stating how to compute the forward observation operator.  Note that 
there must be a case statement entry for each
type obs observation defined even if no special action (just put in a
continue) is required.
<BR>
<P>
! BEGIN DART PREPROCESS GET_EXPECTED_OBS_FROM_DEF <BR>
!         case(RAW_STATE_VARIABLE) <BR>
!         call interpolate(state, location, 1, obs_val, istatus) <BR>
!         case(RAW_STATE_1D_INTEGRAL) <BR>
!            call get_expected_1d_integral(state, location, obs_def%key, obs_val, istatus) <BR>
! END DART PREPROCESS GET_EXPECTED_OBS_FROM_DEF <BR>

<P>
4. Case statement entries for each observation kind defined by this special
obs_def module stating how to read any extra required information from an
obs sequence file. Note that there must be a case statement entry for each
type obs observation defined even if no special action (just put in a
continue) is required. <BR>
<P>
! BEGIN DART PREPROCESS READ_OBS_DEF <BR>
!      case(RAW_STATE_VARIABLE) <BR>
!         continue <BR>
!      case(RAW_STATE_1D_INTEGRAL) <BR>
!         call read_1d_integral(obs_def%key, ifile, fileformat) <BR>
! END DART PREPROCESS READ_OBS_DEF <BR>
<P>
5. Case statement entries for each observation kind defined by this special
obs_def module stating how to write any extra required information to an
obs sequence file. Note that there must be a case statement entry for each
type obs observation defined even if no special action (just put in a
continue) is required. <BR>
! BEGIN DART PREPROCESS WRITE_OBS_DEF <BR>
!      case(RAW_STATE_VARIABLE) <BR>
!         continue <BR>
!      case(RAW_STATE_1D_INTEGRAL) <BR>
!         call write_1d_integral(obs_def%key, ifile, fileformat) <BR>
! END DART PREPROCESS WRITE_OBS_DEF <BR>

<P>
6. Case statement entries for each observation kind defined by this special
obs_def module stating how to interactively create any extra required information.
Note that there must be a case statement entry for each
type obs observation defined even if no special action (just put in a
continue) is required. <BR>
<P>
! BEGIN DART PREPROCESS INTERACTIVE_OBS_DEF <BR>
!      case(RAW_STATE_VARIABLE) <BR>
!         continue <BR>
!      case(RAW_STATE_1D_INTEGRAL) <BR>
!         call interactive_1d_integral(obs_def%key) <BR>
! END DART PREPROCESS INTERACTIVE_OBS_DEF <BR>



<P>

<BR>

<!--==================================================================-->

<A NAME="OTHER MODULES USED"></A>
<BR><HR>
<H2>OTHER MODULES USED</H2>
<PRE>
types_mod
utilities_mod
location_mod (1d_location_mod_only)
time_manager_mod
assim_model_mod
cov_cutoff_mod
</PRE>

<!--==================================================================-->
<!--Note to authors. The first row of the table is different.         -->

<A NAME="Interface"></A>
<BR><HR>
<H2>PUBLIC INTERFACE</H2>

<TABLE>
<TR><TD><em class=call>use obs_def_mod, only : </em></TD>
                   <TD><A HREF="#write_1d_integral">write_1d_integral</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#read_1d_integral">read_1d_integral</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#interactive_1d_integral">interactive_1d_integral</A></TD></TR>
<TR><TD>&nbsp;</TD><TD><A HREF="#get_expected_1d_integral">get_expected_1d_integral</A></TD></TR>
</TABLE>

<BR>

<!--==================================================================-->
<!-- Declare all public entities ...                                  -->
<!-- duplicate public routines template as many times as necessary    -->
<!-- make sure you replace all yyyroutine?? strings                   -->
<!--==================================================================-->

<A NAME="PublicEntities"></A>
<BR><HR>
<H2>PUBLIC COMPONENTS</H2>
The following subroutines are public:

 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="write_1d_integral"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call write_1d_integral(key, ifile, fileformat) </em>
 <pre>
 integer, intent(in)           :: <em class=code>key</em>
 integer, intent(in)           :: <em class=code>ifile</em>
 character(len=32), intent(in) :: <em class=code>fileformat</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
 Writes out the extra information for observation with unique identifier
key for a 1d_integral observation kind. This information includes a header
which identifies the total numbe of 1d_integral observations in the whole
sequence (this is only written on the first call) followed by the half-width,
localization type and number of quadrature points for
this observation,
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>key&nbsp; &nbsp; </em></TD>
     <TD>Unique integer key associated with the observation being 
         processed.</TD></TR>
 <TR><TD valign=top><em class=code>ifile&nbsp; &nbsp; </em></TD>
     <TD>Unit number on which observation sequence file is open</TD></TR>
 <TR><TD valign=top><em class=code>fileformat&nbsp; &nbsp; </em></TD>
     <TD>String noting whether file is opened for 'formatted' 
         or 'unformatted' IO.</TD></TR>
 </TABLE>
 <P>
 <!--================================================================-->

 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="read_1d_integral"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call read_1d_integral(key, ifile, fileformat) </em>
 <pre>
 integer, intent(out)          :: <em class=code>key</em>
 integer, intent(in)           :: <em class=code>ifile</em>
 character(len=32), intent(in) :: <em class=code>fileformat</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
 Reads the extra information for observation with unique identifier
key for a 1d_integral observation kind. This information includes a header
which identifies the total numbe of 1d_integral observations in the whole
sequence (this is only read on the first call) followed by the half-width,
localization type and number of quadrature points for
this observation,
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>key&nbsp; &nbsp; </em></TD>
     <TD>Unique integer key associated with the observation being 
        processed.</TD></TR>
 <TR><TD valign=top><em class=code>ifile&nbsp; &nbsp; </em></TD>
     <TD>Unit number on which observation sequence file is open</TD></TR>
 <TR><TD valign=top><em class=code>fileformat&nbsp; &nbsp; </em></TD>
     <TD>String noting whether file is opened for 'formatted' or 
         'unformatted' IO.</TD></TR>
 </TABLE>
 <P>
 <!--================================================================-->

 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="interactive_1d_integral"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call interactive_1d_integral(key) </em>
 <pre>
 integer, intent(out) :: <em class=code>key</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
Uses input from standard in to define the characteristics of a 1D integral
observation. The key that is returned is uniquely associated with the definition
that has been created and can be used by this module to keep track of the
associated parameters (half_width, localization kind, number of quadrature 
points) for this key.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>key&nbsp; &nbsp; </em></TD>
     <TD>Unique identifier associated with the created observation definition 
         in the obs sequence.</TD></TR>
 </TABLE>
 <P>
 <!--================================================================-->
 <!--============= DESCRIPTION OF A SUBROUTINE =======================-->
 <A NAME="get_expected_1d_integral"></A>
 <P></P><HR><P></P>
 <div class=routine>
 <em class=call> call get_expected_1d_integral(state, location, key, val, istatus) </em>
 <pre>
 real(r8), intent(in)            :: <em class=code>state</em>
 type(location_type), intent(in) :: <em class=code>location</em>
 integer, intent(in)             :: <em class=code>key</em>
 real(r8), intent(out)           :: <em class=code>val</em>
 integer, intent(out)            :: <em class=code>istatus</em>
 </pre></div>
 <H3 class=indent1>Description</H3>
 <P>
Computes the forward observation operator for a 1d integral observation.
 </P>
 <TABLE width=100% border=0 summary="" celpadding=3>
 <TR><TD valign=top><em class=code>state&nbsp; &nbsp; </em></TD>
     <TD>Model state vector (or extended state vector).</TD></TR>
 <TR><TD valign=top><em class=code>location&nbsp; &nbsp; </em></TD>
     <TD>Location of this observation.</TD></TR>
 <TR><TD valign=top><em class=code>key&nbsp; &nbsp; </em></TD>
     <TD>Unique integer key associated with this observation.</TD></TR>
 <TR><TD valign=top><em class=code>val&nbsp; &nbsp; </em></TD>
     <TD>Returned value of forward observation operator.</TD></TR>
 <TR><TD valign=top><em class=code>istatus&nbsp; &nbsp; </em></TD>
     <TD>Returned as 0 if forward operator was successfully computed, 
         else returned non-zero.</TD></TR>
 </TABLE>
 <P>
 <!--================================================================-->



<!--==================================================================-->
<!-- Describe the Files Used by this module.                          -->
<!--==================================================================-->
</P>
<A NAME="FilesUsed"></A>
<BR><HR>
<H2>FILES</H2>
<UL><LI>NONE
</UL>

<!--==================================================================-->
<!-- Cite references, if need be.                                     -->
<!--==================================================================-->

<A NAME="References"></A>
<BR><HR>
<H2>REFERENCES</H2>

<!--==================================================================-->
<!-- Describe all the error conditions and codes.                     -->
<!-- Putting a <BR> after the synopsis creates a nice effect.         -->
<!--==================================================================-->

<A NAME="Errors"></A>
<HR>
<H2>ERROR CODES and CONDITIONS</H2>
<div class="errors">
<TABLE border=1 cellspacing=1 cellpadding=10 width=100%>
<TR><TH>Routine</TH><TH>Message</TH><TH>Comment</TH></TR>

<TR><!-- routine --><TD VALIGN=top>interactive_1d_integral</TD>
    <!-- message --><TD VALIGN=top>Not enough space for a 1d_integral_obs. 
                  Can only have max_1d_integral_obs (currently _____).</TD>
    <!-- comment --><TD VALIGN=top> There is only room for a fixed number of
     1d integral observations. The max number is defined by max_1d_integral_obs.
     Set this to a larger value if more are needed. </TD>
</TR>

</TABLE>
</div>

<!--==================================================================-->
<!-- Describe the bugs.                                               -->
<!--==================================================================-->

<A NAME="KnownBugs"></A>
<BR><HR>
<H2>KNOWN BUGS</H2>
<P>
</P>

<!--==================================================================-->
<!-- Describe Future Plans.                                            -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<BR><HR>
<H2>FUTURE PLANS</H2>
<P>
</P>

<!--==================================================================-->

<HR>
</BODY>
</HTML>
