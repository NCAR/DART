<HTML>
<HEAD>
<TITLE>program obs_diag</TITLE>
<link rel="stylesheet" type="text/css" href="../../doc/html/doc.css"></link>
</HEAD>
<BODY>
<!--
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!                                                                       !!
!!                   GNU General Public License                          !!
!!                                                                       !!
!! This file is part of the Data Assimilation Research Testbed (DART).   !!
!!                                                                       !!
!! DART is free software; you can redistribute it and/or modify          !!
!! it and are expected to follow the terms of the GNU General Public     !!
!! License as published by the Free Software Foundation.                 !!
!!                                                                       !!
!! DART is distributed in the hope that it will be useful,               !!
!! but WITHOUT ANY WARRANTY; without even the implied warranty of        !!
!! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         !!
!! GNU General Public License for more details.                          !!
!!                                                                       !!
!! You should have received a copy of the GNU General Public License     !!
!! along with DART; if not, write to:                                    !!
!!          Free Software Foundation, Inc.                               !!
!!          59 Temple Place, Suite 330                                   !!
!!          Boston, MA  02111-1307  USA                                  !!
!! or see:                                                               !!
!!          http://www.gnu.org/licenses/gpl.txt                          !!
!!                                                                       !!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-->

<DIV ALIGN=CENTER>
<A HREF="#Modules">MODULES</A> / 
<A HREF="#Namelist">NAMELIST</A> / 
<A HREF="#FilesUsed">FILES</A> /
<A HREF="#References">REFERENCES</A> /
<A HREF="#Errors">ERRORS</A> /
<A HREF="#KnownBugs">BUGS</A> /
<A HREF="#FuturePlans">PLANS</A>
</DIV>

<!--==================================================================-->

<H1>PROGRAM obs_diag</H1>
<A NAME="HEADER"></A>
<TABLE summary="">
<TR><TD>Contact:       </TD><TD> Tim Hoar     </TD></TR>
<TR><TD>Revision:      </TD><TD> $Revision$ </TD></TR>
<TR><TD>Source:        </TD><TD> $URL$ </TD></TR>
<TR><TD>Change Date:   </TD><TD> $Date$ </TD></TR>
<TR><TD>Change history:</TD><TD> try "svn log" or "svn diff" </TD></TR>
</TABLE>

<!--==================================================================-->

<A NAME="OVERVIEW"></A>
<HR>
<H2>OVERVIEW</H2>

<P>
   Main program for observation-space diagnostics for the models with
   1D locations. The model space is carved up into regions, hence the
   dependency on the location type. There is no discrimination between
   observation types, but the framework is still in the code - the main
   selection block is commented out. The result of the code is a set of
   ASCII files that contain the RMS of the bias and the RMS of the spread
   of the prior (aka 'guess') and posterior (aka 'analysis') estimates 
   as a function of time and region. <em class="new">Separate (pairs of) files are created
	   for each observation type in the observation sequence file.</em>
</P>

<P><em class='new'>
   The J release of DART also implements a DART QC flag that provides 
   information about how the observation was or was not assimilated.
   The DART QC flag is intended to provide information about whether the 
   observation was assimilated, evaluated only, whether the assimilation 
   resulted in a 'good' observation, etc.
   Here is the table that should explain things: 
   <table>
   <tr><th>DART QC flag value</th>
       <th>&nbsp;&nbsp;&nbsp;&nbsp;</th>
       <th align="left">meaning</th></tr>
   <tr><td>0</td><td>&nbsp;</td><td>observation assimilated</td></tr>
   <tr><td>1</td><td>&nbsp;</td><td>observation evaluated only</td></tr>

   <tr><th align="left" colspan=3>everything above this means the prior and posterior are OK</th></tr>

   <tr><td>2</td><td>&nbsp;</td><td>assimilated, but the posterior forward operator failed</td></tr>
   <tr><td>3</td><td>&nbsp;</td><td>Evaluated only, but the posterior forward operator failed</td></tr>

   <tr><th align="left" colspan=3>everything above this means only the prior is OK</th></tr>

   <tr><td>4</td><td>&nbsp;</td><td>prior forward operator failed</td></tr>
   <tr><td>5</td><td>&nbsp;</td><td>not used</td></tr>
   <tr><td>6</td><td>&nbsp;</td><td>prior QC rejected</td></tr>
   <tr><td>7</td><td>&nbsp;</td><td>outlier rejected</td></tr>
   <tr><td>8+</td><td>&nbsp;</td><td>reserved for future use</td></tr>
</table>
</em></P> 

<P>
   The namelist contains several unused features that are simply used 
   to facilitate the matlab plotting routines until such time as the 
   output is reformatted to a netCDF file.
</P>

<P>
Optional namelist interface
<A HREF="#Namelist"><em class=code>&#38;obsdiag_nml</em></A>
may be read from file <em class=file>input.nml</em>.
</P>

<!--==================================================================-->

<A NAME="Modules"></A>
<BR><HR><BR>
<H2>MODULES DIRECTLY USED</H2>
<PRE>
types_mod
obs_sequence_mod
obs_def_mod
location_mod
time_manager_mod
utilities_mod
</PRE>

<H2>MODULES INDIRECTLY USED</H2>
<PRE>
random_seq_mod
random_nr_mod
assim_model_mod
model_mod
</PRE>

<!--==================================================================-->
<!--=================== DESCRIPTION OF A NAMELIST  ===================-->

<A NAME="Namelist"></A>
<BR><HR><BR>
<H2>NAMELIST</H2>
<P>We adhere to the F90 standard of starting a namelist with an ampersand 
'&#38;' and terminating with a slash '/'.
<div class=namelist><pre>
<em class=call>namelist / obsdiag_nml / </em>
      obs_sequence_name, iskip_days, obs_select, rat_cri, 
      input_qc_threshold, bin_width_sections,
      lonlim1, lonlim2, reg_names, verbose
</pre></div>

<H3 class=indent1>Discussion</H3>

<P>This namelist is read in a file called <em class=file>input.nml</em>
</P>

<TABLE border=0 cellpadding=3 width=100%>
<TR><TH align=left>Contents    </TH>
    <TH align=left>Type        </TH>
    <TH align=left>Description </TH></TR>
<TR><!--contents--><TD valign=top>obs_sequence_name        </TD>
    <!--  type  --><TD valign=top>character(len=129)       </TD>
    <!--descript--><TD>Contains name of observation sequence file.
		       Default is "obs_seq.final"</TD></TR>

<TR><!--contents--><TD valign=top>iskip_days     </TD>
    <!--  type  --><TD valign=top>integer        </TD>
    <!--descript--><TD>not used. Future plan is to provide the ability to
	    skip some time before accumulating statistics.<br>
	    Default is 0.</TD></TR>  

<TR><!--contents--><TD valign=top>obs_select     </TD>
    <!--  type  --><TD valign=top>integer        </TD>
    <!--descript--><TD>not used. Future plan is to allow selection
	    of certain types of observations.<br>
	    Default is 1 -- all types used.</TD></TR>  

<TR><!--contents--><TD valign=top>rat_cri        </TD>
    <!--  type  --><TD valign=top>real(r8)       </TD>
    <!--descript--><TD>Critical ratio of distance of the value of 
	    observation from the ensemble mean to the standard 
	    deviation of the ensemble. If this ratio is too large 
	    then the observation is suspect and will be ignored.
	    If this value is larger than the corresponding one in 
	    the filter, then it does nothing; that obs has already 
	    been excluded by the filter.<BR>
	    Default: 4.0</TD></TR>  

<TR><!--contents--><TD valign=top>input_qc_threshold</TD>
    <!--  type  --><TD valign=top>real(r8)         </TD>
    <!--descript--><TD>This mimics the values used by NCEP for their nomenclature 
	    for observation quality control. Any observation with a QC value
            equal to or above the
	    input_qc_threshold is not included in the diagnostics. The total 
	    number of rejected observations is reported as 'NbadQC' in the diagnostics
	    at the end of the run.<br>
	    Default is 4.0</TD></TR>  

<TR><!--contents--><TD valign=top>bin_width_seconds</TD>
    <!--  type  --><TD valign=top>integer         </TD>
    <!--descript--><TD>Specifies the width of the analysis window. All 
	    observations within a window centered at the observation time 
	    +/- bin_width_seconds is used. Default is 0 - half the separation 
	    between observation times as defined in the observation sequence 
	    file is used (i.e. all observations used).</TD></TR>  

<TR><!--contents--><TD valign=top>lonlim1          </TD>
    <!--  type  --><TD valign=top>real(r8) array of length(4)</TD>
    <!--descript--><TD>starting value of coordinates defining 'regions'.
	    A value of -1 indicates the start of 'no region'.<br>
	    Default is (/ 0.0, 0.0, 0.5, -1.0/)</TD></TR>  

<TR><!--contents--><TD valign=top>lonlim2      </TD>
    <!--  type  --><TD valign=top>real(r8) array of length(4)</TD>
    <!--descript--><TD>ending value of coordinates defining 'regions'.
	    A value of -1 indicates the end of 'no region'.<br>
	    Default is (/ 1.0, 0.5, 1.0, -1.0/)</TD></TR>  

<TR><!--contents--><TD valign=top>reg_names      </TD>
    <!--  type  --><TD valign=top>character(len=6), dimension(4)</TD>
    <!--descript--><TD>Array of names for each of the regions.
	    The default example has the unit circle as a whole and divided 
	    into two equal parts, so there are only three regions.<BR>
	    Default: 'whole','yin','yang','bogus' </TD></TR> 

<TR><!--contents--><TD valign=top>verbose      </TD>
    <!--  type  --><TD valign=top>logical      </TD>
    <!--descript--><TD>switch controlling amount of run-time output.<br>
	    Default is .false. (suppress most output)</TD></TR>

</TABLE>

<!--==================================================================-->
<!-- Describe the Files Used by this module.                          -->
<!--==================================================================-->

<A NAME="FilesUsed"></A>
<BR><HR><BR>
<H2>FILES</H2>
<UL>
   <LI>input namelist; <em class=file>input.nml</em>
   <LI>observation sequence file (input) ; from obs_sequence_name
   <LI>output state space 'guess' file; <em class=file>RAW_STATE_VARIABLE_ges_times.dat</em>
   <LI>output state space 'analysis' file; <em class=file>RAW_STATE_VARIABLE_anl_times.dat</em>
   <LI>output plotting attributes file; <em class=file>ObsDiagAtts.m</em>
</UL>
<P>
The output file names are based on the metadata for the observation types.
If the observation sequence file contains observations of KIND_1D_INTEGRAL,
you will get a pair of files: 
<em class=file>RAW_STATE_1D_INTEGRAL_ges_times.dat</em>, and
<em class=file>RAW_STATE_1D_INTEGRAL_anl_times.dat</em>.
</P>

<H3>File formats</H3>
We intend to write the output as netCDF files eventually. Until then,
here's the rosetta stone...

<TABLE>
	<TR><TD>column 1</TD><TD>day of observation</TD></TR>
	<TR><TD>column 2</TD><TD>seconds of observation</TD></TR>
	<TR><TD>column 3</TD><TD>rms of bias</TD></TR>
	<TR><TD>column 4</TD><TD>rms of spread</TD></TR>
	<TR><TD>column 5</TD><TD>number of observations</TD></TR>
	<TR><TD colspan=2>Columns 3,4,5 are repeated for each region</TD></TR>
</TABLE>
If there are no observations in a particular region, the default value of
-99 is used for the bias and spread. The regions themselves are logged
in <em class=file>ObsDiagAtts.m</em>.

<!--==================================================================-->
<!-- Cite references, if need be.                                     -->
<!--==================================================================-->

<A NAME="References"></A>
<BR><HR><BR>
<H2>REFERENCES</H2>

<!--==================================================================-->
<!-- Describe all the error conditions and codes.                     -->
<!-- Putting a <BR> after the synopsis creates a nice effect.         -->
<!--==================================================================-->

<A NAME="Errors"></A>
<HR>
<H2>ERROR CODES and CONDITIONS</H2>
<div class="errors">
<TABLE border=1 cellspacing=1 cellpadding=10 width=100%>
<TR><TH>Routine</TH><TH>Message</TH><TH>Comment</TH></TR>

<TR><!-- routine --><TD VALIGN=top>get_last_obs</TD>
    <!-- message --><TD VALIGN=top>No "last" observation in sequence</TD>
    <!-- comment --><TD VALIGN=top>Must have an incomplete observation sequence file. </TD>
<TR><!-- routine --><TD VALIGN=top>get_first_obs</TD>
    <!-- message --><TD VALIGN=top>No Observations in sequence.</TD>
    <!-- comment --><TD VALIGN=top>Empty observation sequence file.</TD>
</TR>
</TR>

</TABLE>
</div>

<!--==================================================================-->
<!-- Describe the bugs.                                               -->
<!--==================================================================-->

<A NAME="KnownBugs"></A>
<BR><HR><BR>
<H2>KNOWN BUGS</H2>
<P>
</P>

<!--==================================================================-->
<!-- Descibe Future Plans.                                            -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<BR><HR><BR>
<H2>FUTURE PLANS</H2>
<P>
Change output format to netCDF, eliminate reliance on ancillary
plotting attributes file: <em class=file>ObsDiagAtts.m</em>.
</P>

<!--==================================================================-->
<!-- Have not fleshed out this part yet ... ha ha ha                  -->
<!--==================================================================-->

<H3 class=indent1>Discussion</H3>

None at this time.

<!--==================================================================-->

<HR>
</BODY>
</HTML>
