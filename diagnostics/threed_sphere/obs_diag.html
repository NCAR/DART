<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
          "http://www.w3.org/TR/html4/strict.dtd">
<HTML>
<HEAD>
<TITLE>program obs_diag</TITLE>
<link rel="stylesheet" type="text/css" href="../../doc/html/doc.css">
</HEAD>
<BODY>
<A NAME="TOP"></A>

<center>
<A HREF="#Modules">MODULES</A> /
<A HREF="#Namelist">NAMELIST</A> /
<A HREF="#FilesUsed">FILES</A> /
<A HREF="#Usage">USAGE </A> / 
<A HREF="#References">REFERENCES</A> /
<A HREF="#Errors">ERRORS</A> /
<A HREF="#FuturePlans">PLANS</A> /
<A HREF="#PrivateComponents">PRIVATE COMPONENTS</A> /
<A HREF="#Legalese">TERMS OF USE</A>
</center>

<H1>PROGRAM <em class=program>obs_diag</em></H1>
<!-- version tag follows, do not edit --><P>$Id$</P>

<P>
   Main program for evaluating filter performance in observation space. 
   There is also the ability to ingest an observation sequence file and 
   simply output the observation locations - more on that later.
   <br />
   <br />
   Each <em class="file">obs_seq.final</em> file contains an observation 
   sequence that has multiple 'copies' of the observation. One copy is
   the actual observation, another copy is the estimate of the observation 
   from ensemble member 1, ... etc. If the original observation sequence 
   is the result of a 'perfect model' experiment, there is an additional
   copy called the 'truth' - the noise-free expected observation given 
   the true model state. Since this copy does not, in general, exist for
   the high-order models, all comparisons are made with the copy labelled
   'observation'. It may, in some instances be useful to compare against
   the 'truth', in which case you will have to hand-edit the code and 
   recompile. Caveat emptor.
   <br />
   <br />
   The models "expected" observations are compared against the actual
   observations in various ways.
   Each ensemble member applies a forward operator to the state to compute
   the "expected" value of an observation. Given multiple estimates of 
   the observation, several quantities can be calculated. It is possible to
   compute the expected observations from the state vector before 
   assimilating (the "guess", "forecast", or "prior") or after the
   assimilation (the "analysis", or "posterior").<BR>
   <img src="../../doc/html/obs_diag_evolution_example.png" width="375">
   <img src="../../doc/html/obs_diag_profile_example.png" width="375">
   <br />
   There are two versions of this program, one for high-order models that have
   real observations and another for low-order models. Since this program
   is fundamentally interested in the response as a function of region, the 
   division was made if the model has a threed_sphere or a oned 
   <em class=file>location_mod.f90</em>. It did not make sense to ask the 
   <em class=program>lorenz_96</em> model what part of North America you'd like
   to investigate. The low-order models output simple text files instead of
   netCDF files - the intent is to move these toward netCDF files in the near
   future.
   <br />
   <br />
   Identity observations (only possible from "perfect model experiments") 
   are already explored with state-space diagnostics,
   so <em class=program>obs_diag</em> simply skips them.
   <br />
   <br />
   <em class="program">obs_diag</em> is designed to explore the effect of 
   the assimilation in two ways 1) as a function of time for a particular 
   variable and level (this is the figure on the left) and 2) as a 
   time-averaged vertical profile (figure on the right).
   These figures were created by a couple Matlab&#174; scripts that query 
   the <em class="file">obs_diag_output.nc</em> file: 
   <em class="file">DART/diagnostics/matlab/</em><em class="program">plot_evolution.m</em> 
   and <em class="program">plot_profile.m</em>. Each of these takes as input a 
   file name and a 'quantity' to plot ('rmse','spread','totalspread', ...)
   and exhaustively plots the quantity (for every variable, every level, 
   every region) in a single matlab figure window  - and creates a series 
   of .ps files with multiple pages for each of the figures. 
   The directory gets cluttered with them.
   <br />
   <br />
   <em class="program">obs_diag</em>
   is not explicitly designed to take explore OSSE's.  In general, it is 
   used for 'real' observations and looks through the metadata for
   the observation sequence to identify which 'copy' is labeled 'observation'.
   It is THAT copy that is used as the noisy estimate of the truth.
   <br />
   <br />
   The observation sequence files contain only the time of the observation, 
   nothing of the assimilation interval, etc. - so it requires user guidance 
   to declare what sort of temporal binning for the temporal evolution 
   plots. I do a 'bunch' of arithmetic on the namelist times to convert 
   them to a series of temporal bin edges that are used when traversing 
   the observation sequence. The actual algorithm is that the user input for
   the start date and bin width set up a sequence that ends in one of two ways ...
   the last time is reached or the number of bins has been reached. 
   <br />
   <br />
   <em class=program>obs_diag</em> reads <em class=file>obs_seq.final</em>
   files and calculates the following quantities for an arbitrary number of
   regions and levels:
</P>

   <table width="90%">
   <tr><td valign="top"><b>rmse</b></td>
       <td>The root-mean-squared error (the horizontal wind components 
           are also used to calculate the vector wind velocity 
           and its RMS error).</td></tr>
   <tr><td valign="top"><b>bias</b></td>
       <td>The simple sum of forecast - observation. The bias of the 
           horizontal wind speed (not velocity) is also computed.</td></tr>
   <tr><td valign="top"><b>spread</b></td>
       <td>The standard deviation of the univariate obs.
           DART does not exploit the bivariate nature of U,V winds
           and so the spread of the horizontal wind is defined as
           the sum of the spreads of the U and V components.</td></tr>
   <tr><td valign="top"><b>totalspread&nbsp;&nbsp;&nbsp;</b></td>
       <td>The total standard deviation of the estimate. We pool the
           ensemble variance of the observation plus the observation error 
           variance and take the square root.</td></tr>
   <tr><td valign="top"><b>Nposs</b></td>
       <td>The number of observations available to be assimilated.</td></tr>
   <tr><td valign="top"><b>Nused</b></td>
       <td>The number of observations that were assimilated.</td></tr>
   </table>

<P>
   The temporal evolution of the above quantities for every observation 
   type (RADIOSONDE_U_WIND_COMPONENT, AIRCRAFT_SPECIFIC_HUMIDITY, ...) is 
   recorded in the output netCDF file - 
   <em class="file"><b>obs_diag_output.nc</b></em>.
   This netCDF file can then be loaded and displayed using the 
   Matlab&#174; scripts in 
   <em class=file>..../DART/diagnostics/matlab</em>.
   (which may depend on functions in <em class=file>..../DART/matlab</em>).
   The temporal, geographic, and vertical binning are under namelist
   control.
   Temporal averages of the above quantities are also stored in the netCDF
   file. Normally, it is useful to skip the 'burn-in' period - the amount
   of time to skip is under namelist control.
</P>

<P>
   The 3D <em class=program>obs_diag</em> has:
</P>
<OL>
   <LI>an improved capacity for reading multiple 
   <em class=file>obs_seq.final</em> files (that don't require an 
   arcane naming convention),</LI>

   <LI>a greatly expanded namelist control (including multiple, user-defined 
   levels),</LI>

   <LI>(one) netCDF output file <em class="file">obs_diag_output.nc</em>
   (instead of MANY impenetrable plain text files) -- complete with all 
   the metadata needed to make sensible, accurate graphics,</LI>

   <LI>removed the <em class="removed">obs_select</em> namelist variable,</LI>

   <LI>better reporting of the times/dates it encounters in the input files, 
   making it easier to set the namelist parameters 
   <em class=code>first_bin_center, last_bin_center</em>,</LI>

   <LI>regions that can "wrap" in longitude,</LI>

   <LI>the ability to output a text file of the locations of the observations
       to facilitate scatterplots of observation density by type and QC value,</LI>

   <LI>discontinued the rejection of observations based on the 
   <em class=code>rat_cri</em> or <em class=code>input_qc_threshold</em> 
   namelist variables (the counts of these are available in the 
   netCDF file as <b>NbadQC</b> and <b>NbadIZ</b>, respectively).</LI>
</OL>

<P>
   The Jamaica release of DART also implements a DART QC flag that provides
   information about how the observation was or was not assimilated.
   The DART QC flag is intended to provide information about whether the
   observation was assimilated, evaluated only, whether the assimilation resulted
   in a 'good' observation, etc. Here is the table that should explain things:
</P> 

<table width="80%">
   <tr><th align="left">DART QC flag value</th><th align="left">meaning</th></tr>
   <tr><td>0</td><td>observation assimilated</td></tr>
   <tr><td>1</td><td>observation evaluated only</td></tr>

   <tr><th align="left" colspan=2>DART QC values higher than this means the prior and posterior are OK, but ...</th></tr>

   <tr><td>2</td><td>assimilated, but the posterior forward operator failed</td></tr>
   <tr><td>3</td><td>Evaluated only, but the posterior forward operator failed</td></tr>

   <tr><th align="left" colspan=2>DART QC values higher than this means only the prior is OK, but ...</th></tr>

   <tr><td>4</td><td>prior forward operator failed</td></tr>
   <tr><td>5</td><td>not used because of namelist control</td></tr>

   <tr><th align="left" colspan=2>DART QC values higher than this are bad news.</th></tr>

   <tr><td>6</td><td>prior QC rejected</td></tr>
   <tr><td>7</td><td>outlier rejected</td></tr>
   <tr><td>8+</td><td>reserved for future use</td></tr>
</table>

<P>
   Optional namelist interface
   <A HREF="#Namelist"><em class=code>&amp;obs_diag_nml</em></A>
   may be read from file <em class=file>input.nml</em>.
</P>

<!--==================================================================-->

<A NAME="Modules"></A>
<HR>
<H2>OTHER MODULES USED</H2>
<PRE>
obs_sequence_mod
obs_kind_mod
obs_def_mod (and possibly other obs_def_xxx mods)
assim_model_mod
random_seq_mod
random_nr_mod
model_mod
location_mod
types_mod
time_manager_mod
utilities_mod
sort_mod
</PRE>

<!--==================================================================-->
<!--=================== DESCRIPTION OF A NAMELIST  ===================-->
<!--==================================================================-->

<A NAME="Namelist"></A>
<HR>
<H2>NAMELIST</H2>
<P>We adhere to the F90 standard of starting a namelist with an ampersand
'&amp;' and terminating with a slash '/' for all our namelist input.
Consider yourself forewarned that filenames that contain a '/' must be
enclosed in quotes to prevent them from prematurely terminating the namelist.
The namelist declaration (i.e. what follows) has a different syntax, naturally.
</P>
<div class=namelist>
<pre>
<em class=call>namelist / obs_diag_nml / </em> 
      obs_sequence_name, obs_sequence_list, first_bin_center, last_bin_center, 
      bin_separation, bin_width, time_to_skip, max_num_bins, 
      plevel, hlevel, mlevel, <em class=removed>obs_select</em>, 
      rat_cri, input_qc_threshold, 
      Nregions, lonlim1, lonlim2, latlim1, latlim2, 
      reg_names, print_mismatched_locs, print_obs_locations, verbose
</pre>
</div>

<div class=indent1>
<!-- Description -->

<P>This namelist is read in a file called <em class=file>input.nml</em>. <BR>
   The date-time integer arrays in this namelist have the form 
   (YYYY,&nbsp;MO,&nbsp;DA,&nbsp;HR,&nbsp;MIN,&nbsp;SEC). <BR>
   The allowable ranges for the region boundaries are: latitude [-90.,90], 
   longitude [0.,Inf.]
<br />
<br />
   You can only specify <strong>either</strong> 
   <em class="code">obs_sequence_name</em>
   <strong>or</strong> 
   <em class="code">obs_sequence_list</em> -- not both.
   One of them has to be an empty string ... i.e. <em class="code">''</em>.
</P>

<TABLE border=0 cellpadding=3 width=100%>
<TR><TH align=left>Contents    </TH>
    <TH align=left>Type        </TH>
    <TH align=left>Description </TH></TR>

<TR><!--contents--><TD valign=top>   obs_sequence_name </TD>
    <!--  type  --><TD valign=top>   character         </TD>
    <!--descript--><TD>Name of the observation sequence file(s). <BR>
            This may be a relative or absolute filename. If the filename
            contains a '/', the filename is considered to be comprised of
	    everything to the right, and a directory structure to the left.
	    The directory structure is then queried to see if it can be
	    incremented to handle a sequence of observation files.
	    The default behavior of <em class="program">obs_diag</em> 
	    is to look for additional files to include until the files 
	    are exhausted or an <em class=file>obs_seq.final</em> file 
	    is found that contains observations beyond the timeframe of 
	    interest.<BR>e.g. 'obsdir_001/obs_seq.final' will cause
	    <em class="program">obs_diag</em> to look for
	    'obsdir_002/obs_seq.final', and so on.<BR>
            If this is set, 'obs_sequence_list' must be set to ''.
	    Default 'obs_seq.final'</TD></TR>  

<TR><!--contents--><TD valign=top>   obs_sequence_list </TD>
    <!--  type  --><TD valign=top>   character         </TD>
    <!--descript--><TD>Name of an ascii text file which contains a list
            of one or more observation sequence files, one per line.
            If this is specified, 'obs_sequence_name' must be set to ''. 
            Can be created by any method, including sending the output
            of the 'ls' command to a file, a text editor, or another program.
            If this is set, 'obs_sequence_name' must be set to ''.
	    <BR>
	    Default '' - an empty string.</TD></TR>  

<TR><!--contents--><TD valign=top>   first_bin_center </TD>
    <!--  type  --><TD valign=top>  integer, dimension(6) </TD>
    <!--descript--><TD>first timeslot of the first obs_seq.final file to process.
	    The six integers are: year, month, day, hour, hour, minute, 
	    second -- in that order. <em class="program">obs_diag</em> has
	    improved run-time output that reports the time and date of the 
	    first and last observations in every observation sequence file. 
	    Look for the string 'First observation date' in the logfile. 
	    If the <em class="code">verbose</em> is 'true', it is also 
	    written to the screen.<BR>
            Default: 2003, 1, 1, 0, 0, 0</TD></TR>  

<TR><!--contents--><TD valign=top>   last_bin_center  </TD>
    <!--  type  --><TD valign=top>  integer, dimension(6) </TD>
    <!--descript--><TD>last timeslot of interest.
	    (reminder: the last timeslot of day 1 is hour 0 of day 2) 
	    The six integers are: year, month, day, hour, hour, minute, 
	    second -- in that order. This does not need to be exact,
            the values from <em class=code>first_bin_center</em> and 
	    <em class=code>bin_separation</em> are used to populate the time 
	    array and stop on or before the time defined by 
	    <em class=code>last_bin_center</em>. 
	    See also <em class=code>max_num_bins</em>.<BR>
            Default: 2003, 1, 2, 0, 0, 0</TD></TR>  

<TR><!--contents--><TD valign=top>   bin_separation       </TD>
    <!--  type  --><TD valign=top>  integer, dimension(6) </TD>
    <!--descript--><TD>Time between bin centers.
	    The year and month values <em>must</em> be zero.<BR>
            Default: 0, 0, 0, 6, 0, 0</TD></TR>  

<TR><!--contents--><TD valign=top>   bin_width        </TD>
    <!--  type  --><TD valign=top>  integer, dimension(6) </TD>
    <!--descript--><TD>Time span around bin centers in which obs will be 
	    compared.  The year and month values <em>must</em> be zero. 
	    Frequently, but not required to be, the same as the values 
	    for bin_separation.<BR>
            Default: 0, 0, 0, 6, 0, 0</TD></TR>  

<TR><!--contents--><TD valign=top>   time_to_skip     </TD>
    <!--  type  --><TD valign=top>  integer, dimension(6) </TD>
    <!--descript--><TD>Time span at the beginning to skip when calculating 
	    vertical profiles of rms error and bias. The year and month 
	    values <em>must</em> be zero. Useful because it takes some 
	    time for the assimilation to settle down from the climatological 
	    spread at the start.<BR>
            Default: 0, 0, 1, 0, 0, 0</TD></TR>  

<TR><!--contents--><TD valign=top>   max_num_bins  </TD>
    <!--  type  --><TD valign=top>   integer       </TD>
    <!--descript--><TD>This provides an alternative way to declare the 
            <em class=code>last_bin_center</em>. 
	    If <em class=code>max_num_bins</em> is set to '10', only
	    10 timesteps will be output - provided 
	    <em class=code>last_bin_center</em> is set to some later date. 
	    <BR>
            Default: 1000000</TD></TR>  

<TR><!--contents--><TD valign=top>   plevel     </TD>
    <!--  type  --><TD valign=top> integer, <em class="new">dimension(50)</em></TD>
    <!--descript--><TD>The midpoints defining the pressure levels for the 
            vertical binning. There is no specification of bin width - a 
	    continuum is used. If a single midpoint value is entered, the 
	    bin edges are +/- 10% of the midpoint value. If you'd like to 
	    change that ... see the routine 
	    <em class="routine">Rmidpoints2edges()</em>.<BR>
            Default: (1000, 925, 850, 700, 500, 400, 300, 
	    250, 200, 150, 100)</TD></TR>  

<TR><!--contents--><TD valign=top>   hlevel     </TD>
    <!--  type  --><TD valign=top> integer, <em class="new">dimension(50)</em></TD>
    <!--descript--><TD>Same, but for observations that have height(m) as the 
	    vertical coordinate.<BR>
            Default: (1000, 2000, 3000, 4000, 5000, 6000,
	    7000, 8000, 9000, 10000, 11000)</TD></TR>  

<TR><!--contents--><TD valign=top>   mlevel     </TD>
    <!--  type  --><TD valign=top> integer, <em class="new">dimension(50)</em></TD>
    <!--descript--><TD>Same, but for observations on model level 
            (good luck getting them).<BR>
            Default: (1, 2, 3, 4, 5, 6, 7, 8, 9, 10)</TD></TR>  

<TR><!--contents--><TD valign=top><em class="removed">obs_select </em></TD>
    <!--  type  --><TD valign=top>   integer    </TD>
    <!--descript--><TD><em class="removed">Which obs subset to use; all(1), 
            radiosonde only(2), everything but radiosondes(3).</em> 
	    Removed because all observations are independently processed.<BR>
            </TD></TR>  

<TR><!--contents--><TD valign=top>   rat_cri    </TD>
    <!--  type  --><TD valign=top>   real       </TD>
    <!--descript--><TD>Ratio of 'distance' of the ensemble mean to the observation 
	    in terms of the standard deviation of the ensemble and
	    observational error.<br>
	    <em class="code">abs(prior_mean-obsval) / sqrt(prior_spread+obs_error_variance)</em><br>
	    Since we generally don't have all the ensemble members (in the
	    <em class="file">obs_seq.final</em> file) we cannot
	    calculate the covariance term that should be in the denominator, 
	    so it is not really the normalized distance. If this ratio is 
	    larger than <em class="code">rat_cri</em> then the observation 
	    <em class="removed">is suspect and will be ignored</em> will
	    simply be counted in <b>NbadIZ</b>. 
	    A histogram of the ratios is saved in <em
	    class="file">LargeInnov.txt</em>, as are individual observations
	    that have a large ratio (i.e. the outliers)<BR>
            Default: 5000.0</TD></TR>  

<TR><!--contents--><TD valign=top>   input_qc_threshold </TD>
    <!--  type  --><TD valign=top>   real         </TD>
    <!--descript--><TD>Observations with quality control values greater than this
	    <em class="removed">will be excluded from the diagnostics</em>
	    will be counted in <b>NbadQC</b>.<BR>
            Default: 4.0</TD></TR>  

<TR><!--contents--><TD valign=top>   Nregions   </TD>
    <!--  type  --><TD valign=top>   integer    </TD>
    <!--descript--><TD>Number of regions of the globe for which you'd like
	    obs space diagnostics. Must be between [1,50].<BR>
	    Default: 4</TD></TR>  

<TR><!--contents--><TD valign=top>   lonlim1    </TD>
    <!--  type  --><TD valign=top>   real, <em class="new">dimension(50)</em></TD>
    <!--descript--><TD>Westernmost longitudes of each of the regions.<BR>
	    Default: 0.0, 0.0, 0.0, 235.0</TD></TR>  

<TR><!--contents--><TD valign=top>   lonlim2    </TD>
    <!--  type  --><TD valign=top>   real, <em class="new">dimension(50)</em></TD>
    <!--descript--><TD>Easternmost longitudes of each of the regions.
            <em class="new">If any of these values is <b>less than</b>
	    the westernmost values, it defines a region that spans the 
	    prime meridian. No problem.</em> It is perfectly acceptable 
	    to specify lonlim1 = 330 , lonlim2 = 50 to identify a region
	    like "Africa".<BR>
	    Default: 360.0, 360.0, 360.0, 295.0</TD></TR>  

<TR><!--contents--><TD valign=top>   latlim1    </TD>
    <!--  type  --><TD valign=top>   real, <em class="new">dimension(50)</em></TD>
    <!--descript--><TD>Southernmost latitudes of the regions.<BR>
	    Default: 20.0, -80.0, -20.0, 25.0</TD></TR>  

<TR><!--contents--><TD valign=top>   latlim2    </TD>
    <!--  type  --><TD valign=top>   real, <em class="new">dimension(50)</em></TD>
    <!--descript--><TD>Northernmost latitudes of the regions.<BR>
	    Default: 80.0, -20.0, 20.0, 55.0</TD></TR>  

<TR><!--contents--><TD valign=top>   reg_names  </TD>
    <!--  type  --><TD valign=top>   character(len=129), <em class="new">dimension(50)</em>  </TD>
    <!--descript--><TD>Array of names for the regions to be analyzed.<BR>
	    Default: 'Northern&nbsp;Hemisphere','Southern&nbsp;Hemisphere',
	    'Tropics','North&nbsp;America'</TD></TR>  

<TR><!--contents--><TD valign=top>   print_mismatched_locs </TD>
    <!--  type  --><TD valign=top>   logical               </TD>
    <!--descript--><TD>Print instances where U and V "pairs" don't have the 
	    same location.<BR>
	    Default: .false. </TD></TR>  

<TR><!--contents--><TD valign=top>   print_obs_locations </TD>
    <!--  type  --><TD valign=top>   logical             </TD>
    <!--descript--><TD>Create additional output files with the lat/lon
            location of each observation, obs type, and QC value. These
	    files are named <em
	    class="file">observation_locations.xxx.dat</em> and may be
	    plotted with <em
	    class="file">DART/diagnostics/matlab/plot_observation_locations.m</em>.
	    There is one output file per temporal bin.
	    For pathological reasons, these files cannot exist prior to execution.
	    If they do, an error will result, and execution halts..
	    <BR>
	    Default: .false. </TD></TR>  

<TR><!--contents--><TD valign=top>   verbose   </TD>
    <!--  type  --><TD valign=top>   logical   </TD>
    <!--descript--><TD>Print extra info about the obs_diag run.<BR>
            Default: .false. </TD></TR>  

</TABLE>

</div>
<br>

<!--==================================================================-->
<!-- Describe the Files Used by this module.                          -->
<!--==================================================================-->

<A NAME="FilesUsed"></A>
<HR>
<H2>FILES</H2>
<UL><LI><em class="file">input.nml</em> is used for 
        <em class="code">obs_diag_nml</em></LI>
    <LI><em class="file">obs_diag_output.nc</em> is the 
        netCDF output file</LI>
    <LI>the oned version of <em class="program">obs_diag</em> outputs many
    files of the form "OBS_TYPE_VARIABLE_diagnostic.dat" and one text file 
    <em class="file">obsDiagAtts.m</em> containing the metadata</LI>
    <LI><em class="file">dart_log.out</em> list directed output 
        from the obs_diag.</LI>
    <LI><em class="file">LargeInnov.txt</em> contains the distance ratio 
	histogram -- useful for estimating rat_cri.</LI>
    <LI><em class="file">observation_locations.xxx.dat</em> contains the
    locations for all the observation in temporal bin "xxx". These are 
    only created if the namelist variable 
    <em class="code">print_obs_locations</em> is set to 
    <em class="code">.true.</em> 
	</LI>
</UL>

<P>
Obs_diag may require a model input file from which to get grid information, 
metadata, and links to modules providing the models expected observations.
It all depends on what's needed by the <em class="file">model_mod.f90</em> 
</P>

<H3 class=indent1>Discussion of obs_diag_output.nc variables</H3>

<P>
Every observation type encountered in the observation sequence file is 
tracked separately, and aggregated into temporal and 3D spatial bins.
There are two main efforts to this program. One is to track the temporal
evolution of any of the quantities available in the netCDF file for any
possible observation type: 
</P>
<div class="unix">ncdump -v CopyMetaData,ObservationTypes obs_diag_output.nc</div>
<P>
The other is to explore the vertical profile of a particular observation
kind. By default, each observation kind has a 'guess/prior' value and
an 'analysis/posterior' value - which shed some insight into the 
innovations.
</P>

<H4 class=indent1>temporal evolution</H4>

<P>
The <em class="file">obs_diag_output.nc</em> output file has all the
metadata I could think of, as well as separate variables for every
observation type in the observation sequence file. Furthermore, there
is a separate variable for the 'guess/prior' and 'analysis/posterior'
estimate of the observation. To distinguish between the two, a suffix
is appended to the variable name.  An example seems appropriate:
</P>
<pre>
  ...
  char CopyMetaData(copy, stringlength) ;
          CopyMetaData:long_name = "quantity names" ;
  char ObservationTypes(obstypes, stringlength) ;
          ObservationTypes:long_name = "DART observation types" ;
          ObservationTypes:comment = "table relating integer to observation type string" ;
  float RADIOSONDE_U_WIND_COMPONENT_guess(time, copy, plevel, region) ;
          RADIOSONDE_U_WIND_COMPONENT_guess:_FillValue = -888888.f ;
          RADIOSONDE_U_WIND_COMPONENT_guess:missing_value = -888888.f ;
  float RADIOSONDE_V_WIND_COMPONENT_guess(time, copy, plevel, region) ;
          RADIOSONDE_V_WIND_COMPONENT_guess:_FillValue = -888888.f ;
          RADIOSONDE_V_WIND_COMPONENT_guess:missing_value = -888888.f ;
  ...
  float MARINE_SFC_ALTIMETER_guess(time, copy, surface, region) ;
          MARINE_SFC_ALTIMETER_guess:_FillValue = -888888.f ;
          MARINE_SFC_ALTIMETER_guess:missing_value = -888888.f ;
  ...
  float RADIOSONDE_WIND_VELOCITY_guess(time, copy, plevel, region) ;
          RADIOSONDE_WIND_VELOCITY_guess:_FillValue = -888888.f ;
          RADIOSONDE_WIND_VELOCITY_guess:missing_value = -888888.f ;
  ...
  float RADIOSONDE_U_WIND_COMPONENT_analy(time, copy, plevel, region) ;
          RADIOSONDE_U_WIND_COMPONENT_analy:_FillValue = -888888.f ;
          RADIOSONDE_U_WIND_COMPONENT_analy:missing_value = -888888.f ;
  float RADIOSONDE_V_WIND_COMPONENT_analy(time, copy, plevel, region) ;
          RADIOSONDE_V_WIND_COMPONENT_analy:_FillValue = -888888.f ;
          RADIOSONDE_V_WIND_COMPONENT_analy:missing_value = -888888.f ;
  ...
</pre>
<P>
There are several things to note:<br>
1) the 'WIND_VELOCITY' component is nowhere 'near' the corresponding U,V components.<br>
2) all of the 'guess' variables come before the matching 'analy' variables.<br>
3) surface variables (i.e. <tt>MARINE_SFC_ALTIMETER</tt> have a
coordinate called 'surface' as opposed to 'plevel' for the others in
this example).
</P>

<H4 class=indent1>vertical profiles</H4>
<P>
Believe it or not, there are another set of netCDF variables specifically 
for the vertical profiles, essentially duplicating the previous
variables but <b>without the 'time' dimension</b>. These are
distinguished by the suffix added to the observation kind - 'VPguess'
and 'VPanaly' - 'VP' for Vertical Profile. 
</P>
<pre>
  ...
  float SAT_WIND_VELOCITY_VPguess(copy, plevel, region) ;
          SAT_WIND_VELOCITY_VPguess:_FillValue = -888888.f ;
          SAT_WIND_VELOCITY_VPguess:missing_value = -888888.f ;
  float RADIOSONDE_U_WIND_COMPONENT_VPanaly(copy, plevel, region) ;
          RADIOSONDE_U_WIND_COMPONENT_VPanaly:_FillValue = -888888.f ;
          RADIOSONDE_U_WIND_COMPONENT_VPanaly:missing_value = -888888.f ;
  ...
</pre>
<P>
Observations flagged as 'surface' do not participate in the vertical
profiles (Because surface variables cannot exist on any other level,
there's not much to plot!). Observations on the lowest level DO 
participate. There's a difference!
</P>

<!--==================================================================-->
<!-- Discuss  typical usage of obs_diag.                              -->
<!--==================================================================-->

<A NAME="Usage"></A>
<HR>
<H2>USAGE</H2>

<P>
Obs_diag is built in .../DART/models/your_model/work, in the same way
as the other DART components.
</P>

<H3 class=indent1>multiple observation sequence files</H3>
<P>
Perhaps the most user-friendly enhancement is the strategy for processing
a series of observation sequence files. Everything keys off the 
<em class=code>obs_sequence_name</em> namelist variable. Several examples
might be the most effective description.
</P>
<table width="100%">
<TR><TH width=50%>value</TH><TH>effect</TH></TR>

<TR><TD valign="top">"obs_seq.final"</TD>
    <TD>A single file is processed.
        The file must exist in the current directory.</TD></TR>

<TR><TD valign="top">"/path_to/nirvana/obs_seq.final"</TD>
    <TD>A single file is processed.
        The file must exist where you said it exists.</TD></TR>

<TR><TD valign="top">"../nirvana/obs_seq.final"</TD>
    <TD>A single file is processed.
        Relative pathnames work just fine.</TD></TR>

<TR><TD valign="top">"/path_to/nirvana_001/obs_seq.final"</TD>
    <TD>A single file is processed, and more are expected.
        Because the directory name contains an underscore ("_") and the 
        portion of the directory to the right of the (rightmost) 
        underscore can be incremented, <em class="program">obs_diag</em> 
	   will try to look for the next directory in the sequence, i.e.
        "/path_to/nirvana_002/obs_seq.final". The tricky part is that 
	   the number of digits in the directory numbering must remain
	   constant. Most (all?) of the DART scripts that produce these
	   directories have historically used a constant number of digits
	   so they alphabetically and numerically 'list' identically.
	   <em class="program">obs_diag</em> will stop when it runs out
	   of files to ingest, or if it encounters an observation sequence
	   file whose first time is beyond the timeframe of interest.</TD></TR>
</table>
  
<H3 class=indent1>plotting locations</H3>
<P>
<em class="program">obs_diag</em> does not plot your locations.
Since <em class="program">obs_diag</em> already reads observation
sequences, it is a tiny extension to write out files that contain 
rudimentary location information. 
If you set the value of the namelist parameter <em class="code">
print_obs_locations</em> to <tt>.true.</tt>, you can create
output files (of the form
<em class="file">observation_locations.xxx.dat</em>) which may then be plotted 
with just about anything ... the first line of the file (they are 
plain text, despite the .dat suffix) explains it all. One of the 
columns in the output files is the observation type - which can 
be decoded by using the key in <em class="file">obs_diag_output.nc</em> -
specifically, try the unix command:
</P>

<div class="unix">ncdump -v ObservationTypes obs_diag_output.nc</div>
<BR>

<table width="100%">
<TR><TD>
<img src="../../doc/html/obs_diag_location_example.png" width="500"
     alt="map of the world with altimeter observation locations
	plotted"></TD>
<TD>The Matlab&#174; script <em class="file">plot_observation_locations.m</em>
automatically decodes the observation types and creates a legend. 
It also allows plotting of observations with select QC values. 
So, for example, you can plot the location of all the observations 
that WERE NOT assimilated successfully.<BR>
Sometimes it is useful to plot observation sequence files that have
not yet been assimilated, so they have no ensemble estimates. The
rest of <em class="program">obs_diag</em> is pretty useless, but 
you can still output the observation locations.</TD></TR>
</table>

<!--==================================================================-->
<!-- Cite references, if need be.                                     -->
<!--==================================================================-->

<A NAME="References"></A>
<HR>
<H2>REFERENCES</H2>
<ol>
<li> none </li>
</ol>

<!--==================================================================-->
<!-- Describe all the error conditions and codes.                     -->
<!--==================================================================-->

<A NAME="Errors"></A>
<HR>
<H2>ERROR CODES and CONDITIONS</H2>
<div class=errors>
<TABLE border=1 cellspacing=1 cellpadding=10 width=100%>
<TR><TH>Routine</TH><TH>Message</TH><TH>Comment</TH></TR>

<TR><!-- routine --><TD VALIGN=top>obs_diag</TD>
    <!-- message --><TD VALIGN=top>No first observation  in sequence.</TD>
    <!-- comment --><TD VALIGN=top>get_first_obs couldn't find a "first obs" 
                                   in the obs_seq.final. </TD>
</TR>
<TR><!-- routine --><TD VALIGN=top>obs_diag</TD>
    <!-- message --><TD VALIGN=top>No last observation in sequence</TD>
    <!-- comment --><TD VALIGN=top>get_last_obs couldn't find a "last obs" 
                                   in the obs_seq.final </TD>
</TR>
<TR><!-- routine --><TD VALIGN=top>obs_diag</TD>
    <!-- message --><TD VALIGN=top>metadata incomplete</TD>
    <!-- comment --><TD VALIGN=top>Couldn't find the index for the
    observatoin value in the observation sequence file. It is the only
    one that is required.</TD>
</TR>
<TR><!-- routine --><TD VALIGN=top>filter_get_obs_info</TD>
    <!-- message --><TD VALIGN=top>Vertical coordinate not recognized</TD>
    <!-- comment --><TD VALIGN=top>It must be "surface", "pressure", or "height"</TD>
</TR>
<TR><!-- routine --><TD VALIGN=top>Convert2Time</TD>
    <!-- message --><TD VALIGN=top>namelist parameter out-of-bounds. Fix and try again</TD>
    <!-- comment --><TD VALIGN=top>bin_width, bin_separation, and time_to_skip must have 
                                   year = 0 and month = 0</TD>
</TR>
<TR><!-- routine --><TD VALIGN=top>ObsLocationsExist</TD>
    <!-- message --><TD VALIGN=top>Cannot have pre-existing obs location
    output files. Stopping.</TD>
    <!-- comment --><TD VALIGN=top>It is far easier to implement the
    logic to output these files if they don't exist in the first place.
    Remove anything/everything like "observation_locations.xxx.dat" from
    the current directory and try again.</TD>
</TR>
</TABLE>
</div>

<H2>KNOWN BUGS</H2>
<P>
none at this time
</P>

<!--==================================================================-->
<!-- Describe Future Plans.                                           -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<HR>
<H2>FUTURE PLANS</H2>
<P>
The RMSE of the vector wind velocity is being used.
The bias is actually the bias of the wind speed, with no regard to
direction. Seems like this is not consistent ... 
</P>

<!--==================================================================-->
<!-- PrivateComponents                                                -->
<!--==================================================================-->

<A NAME="PrivateComponents"></A>
<HR>
<H2>PRIVATE COMPONENTS</H2>
<P>
N/A
</P>

<!--==================================================================-->
<!-- Legalese & Metadata                                              -->
<!--==================================================================-->

<A NAME="Legalese"></A>
<HR>
<H2>Terms of Use</H2>

<P>
DART software - Copyright &#169; 2004 - 2010 UCAR.<br>
This open source software is provided by UCAR, "as is",<br>
without charge, subject to all terms of use at<br>
<a href="http://www.image.ucar.edu/DAReS/DART/DART_download">
http://www.image.ucar.edu/DAReS/DART/DART_download</a>
</P>

<TABLE border=0 cellpadding=0 width=100% summary="">
<TR><TD valign=top>Contact:       </TD><TD> Tim Hoar </TD></TR>
<TR><TD valign=top>Revision:      </TD><TD> $Revision$ </TD></TR>
<TR><TD valign=top>Source:        </TD><TD> $URL$ </TD></TR>
<TR><TD valign=top>Change Date:   </TD><TD> $Date$ </TD></TR>
<TR><TD valign=top>Change&nbsp;history:&nbsp;</TD><TD> try "svn&nbsp;log" or "svn&nbsp;diff" </TD></TR>
</TABLE>

<!--==================================================================-->

</BODY>
</HTML>
