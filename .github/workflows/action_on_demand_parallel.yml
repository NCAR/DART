name: Build Everything On Demand

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    container: 
      image: hkershaw/dart-dep:1.0  
      # Need new container to run with RTTOV
      options: "--cap-add=SYS_PTRACE"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set to safe directory
      # Set the repo as safe directory using $GITHUB_WORKSPACE for dynamic path
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Cache dependencies
      # Cache .git folder
        uses: actions/cache@v4
        with:
          path: ~/.cache
          key: ${{ runner.os }}-dart-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-dart-

      - name: Create mkmf.template
      # Copy gfortran mkmf.template only
        run: |
          cp $GITHUB_WORKSPACE/build_templates/mkmf.template.gfortran $GITHUB_WORKSPACE/build_templates/mkmf.template
      
      - name: Run fixsystem
      # Run fixsystem once
        run: |
          export DART=$GITHUB_WORKSPACE
          $DART/assimilation_code/modules/utilities/fixsystem gfortran

      - name: Modify input.nml files
      # Update input.nml files to avoid race conditions when running preprocess
        run: |
          find $GITHUB_WORKSPACE -name input.nml -exec sed -i -e "/^[[:space:]]*#/! s|.*output_obs_def_mod_file.*|output_obs_def_mod_file = './obs_def_mod.f90'|g" \
            -e "/^[[:space:]]*#/! s|.*output_obs_qty_mod_file.*|output_obs_qty_mod_file = './obs_kind_mod.f90'|g" \
            -e "/^[[:space:]]*#/! s|.*output_obs_kind_mod_file.*|output_obs_qty_mod_file = './obs_kind_mod.f90'|g" {} \;

      - name: Run quickbuild.sh scripts
      # Run quickbuild.sh scripts in parallel and log failures
      # Run 4 commands due to Github Actions runner resources
        run: |
          find $GITHUB_WORKSPACE -executable -type f -name quickbuild.sh | xargs -P 4 -I {} bash -c '(cd "$(dirname "{}")" && ./quickbuild.sh) || echo "FAILED: {}" >> $GITHUB_WORKSPACE/quickbuild-failures.txt'

      - name: Report Failures
      # Report all failed runs
        run: |
          if [ -f $GITHUB_WORKSPACE/quickbuild-failures.txt ]; then
            echo "Failed builds:"
            cat $GITHUB_WORKSPACE/quickbuild-failures.txt
            exit 1
          else
            echo "All runs passed"
          fi
